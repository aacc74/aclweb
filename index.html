<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Arcanos Lunch | Sistema de Pedidos (Actualizado)</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            --bg: #0f1724;
            --card: rgba(255,255,255,0.04);
            --glass: rgba(255,255,255,0.06);
            --accent: linear-gradient(135deg,#FF6B35 0%, #FF8A66 100%);
            --accent-flat: #FF6B35;
            --accent-2: #2A9D8F;
            --muted: #9aa4b2;
            --success: #2a9d8f;
            --danger: #e76f51;
            --glass-border: rgba(255,255,255,0.06);
            --shadow: 0 10px 30px rgba(2,6,23,0.6);
        }

        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family:'Poppins',sans-serif;
            background: radial-gradient(1200px 600px at 10% 10%, rgba(255,107,53,0.06), transparent),
                        radial-gradient(1000px 500px at 90% 90%, rgba(42,157,143,0.04), transparent),
                        #071029;
            color:#e6eef8;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }

        /* Header */
        header{
            position:fixed;left:0;right:0;top:0;
            background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255,255,255,0.03);
            z-index:1000;
            padding:14px 20px;
            display:flex;align-items:center;gap:16px;
            box-shadow: var(--shadow);
        }
        .logo{
            display:flex;align-items:center;gap:12px;font-weight:700;font-size:1.2rem;
        }
        .logo .brand-mark{
            width:44px;height:44px;border-radius:10px;
            background:var(--accent);display:flex;align-items:center;justify-content:center;color:white;
            font-weight:700;box-shadow: 0 6px 18px rgba(255,107,53,0.18);
        }
        .spacer{flex:1}
        .header-actions{display:flex;gap:10px;align-items:center}
        .btn{
            background: linear-gradient(90deg,#FF7B4D,#FF6B35);
            padding:10px 14px;border-radius:10px;border:none;color:white;font-weight:600;cursor:pointer;
            box-shadow: 0 8px 20px rgba(255,107,53,0.12);
            transition:transform .18s ease, box-shadow .18s ease;
        }
        .btn.secondary{
            background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);
            box-shadow:none;
        }
        .btn:hover{transform:translateY(-3px)}
        .avatar{
            width:42px;height:42px;border-radius:10px;background:var(--glass);
            display:grid;place-items:center;border:1px solid var(--glass-border);font-weight:600;color:#fff;
        }

        main.container{max-width:1200px;margin:120px auto;padding:20px;width:100%}

        /* Sections layout */
        .grid{display:grid;gap:20px}
        .grid.columns-3{grid-template-columns:1fr 360px 320px}
        .panel{
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border:1px solid rgba(255,255,255,0.03);
            border-radius:12px;padding:18px;box-shadow: 0 8px 30px rgba(2,6,23,0.5);
        }
        h2.section-title{font-family:'Montserrat';font-size:1.4rem;color:#fff;margin-bottom:12px}

        /* Products Grid (Menu) */
        .products-grid{
            display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;
        }
        .product-card{
            border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:10px;
            transition:transform .18s, box-shadow .18s;overflow:hidden;
        }
        .product-card:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(2,6,23,0.6)}
        .product-image{height:140px;border-radius:8px;overflow:hidden;background:#0b1320;display:flex;align-items:center;justify-content:center}
        .product-image img{width:100%;height:100%;object-fit:cover}
        .product-name{font-weight:600;font-size:1rem}
        .price-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
        .badge{padding:6px 8px;border-radius:999px;font-size:0.8rem;background:rgba(255,255,255,0.03);color:var(--muted)}

        /* Cart modal simplified */
        .cart-float{
            position:fixed;right:18px;bottom:18px;background:var(--glass);backdrop-filter:blur(6px);
            border-radius:12px;padding:10px 12px;border:1px solid rgba(255,255,255,0.04);z-index:1100;
            display:flex;gap:10px;align-items:center;cursor:pointer;
        }

        /* Admin Orders Table */
        .orders-table{width:100%;border-collapse:collapse;background:transparent}
        .orders-table th, .orders-table td{padding:12px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.02)}
        .orders-table th{background:transparent;color:var(--muted);font-weight:600;font-size:0.9rem}

        /* Kanban board for kitchen */
        .kanban{
            display:flex;gap:16px;align-items:flex-start;
        }
        .kanban-column{
            flex:1;min-width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
            border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:12px;height:calc(80vh - 120px);overflow:auto;
        }
        .column-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .kol-count{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-weight:700}
        .order-card{
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border:1px solid rgba(255,255,255,0.03);
            padding:12px;border-radius:10px;margin-bottom:10px;box-shadow:0 8px 20px rgba(2,6,23,0.5);
            transition:transform .18s ease, box-shadow .18s ease;
        }
        .order-card:hover{transform:translateY(-6px)}
        .order-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .order-items{font-size:0.9rem;color:var(--muted);margin-bottom:8px}
        .order-actions{display:flex;gap:8px;justify-content:flex-end}

        .status-pill{padding:6px 8px;border-radius:8px;font-weight:700;font-size:0.85rem}
        .status-pending{background:rgba(255,210,170,0.06);color:#ffb288;border:1px solid rgba(255,160,100,0.06)}
        .status-preparing{background:rgba(170,230,210,0.05);color:#2a9d8f;border:1px solid rgba(42,157,143,0.06)}
        .status-ready{background:rgba(200,200,255,0.03);color:#8fa4ff;border:1px solid rgba(120,140,255,0.03)}

        /* Small screens */
        @media (max-width:980px){
            .grid.columns-3{grid-template-columns:1fr}
            .kanban{flex-direction:column}
            header{padding:12px}
        }
    </style>
</head>
<body>
    <!-- Firebase SDK (kept as in original) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <header>
        <div class="logo">
            <div class="brand-mark">AL</div>
            <div>
                <div style="font-size:0.85rem;opacity:0.9">Arcanos Lunch</div>
                <div style="font-size:0.72rem;color:var(--muted)">Sistema de pedidos · Cocina Kanban</div>
            </div>
        </div>
        <div class="spacer"></div>
        <div class="header-actions">
            <div id="roleBadge" style="font-weight:700;color:var(--muted);font-size:0.9rem"></div>
            <button id="btnToggleSidebar" class="btn secondary" style="display:none"><i class="fas fa-bars"></i></button>
            <div id="userArea" class="avatar">U</div>
            <button id="logoutBtn" class="btn secondary"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="container">
        <!-- AUTH SECTION -->
        <section id="authSection" class="panel" style="display:block">
            <h2 class="section-title">Inicia sesión</h2>
            <p id="authMessage">Accede con tu cuenta</p>
            <form id="authForm" style="margin-top:12px;display:flex;flex-direction:column;gap:10px;max-width:420px">
                <input id="authEmail" type="email" placeholder="Email" required style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
                <input id="authPassword" type="password" placeholder="Contraseña" required style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
                <div style="display:flex;gap:8px">
                    <button type="submit" id="authSubmitBtn" class="btn">Iniciar Sesión</button>
                    <button type="button" id="signUpBtn" class="btn secondary">Registrarse</button>
                </div>
            </form>
        </section>

        <!-- MENU & CART -->
        <section id="menuSection" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                <h2 class="section-title">Nuestro Menú</h2>
                <div style="display:flex;gap:8px;align-items:center">
                    <button id="openSidebarBtn" class="btn secondary">Categorías</button>
                    <button id="openCartBtn" class="btn"><i class="fas fa-shopping-cart"></i> Carrito</button>
                </div>
            </div>

            <div class="products-grid" id="productsContainer">
                <!-- productos -->
            </div>
        </section>

        <!-- KITCHEN KANBAN (cocina roles) -->
        <section id="kitchenSection" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                <h2 class="section-title">Tablero Cocina</h2>
                <div style="display:flex;gap:8px;align-items:center">
                    <div style="color:var(--muted)">Filtro: <span id="kitchenFilterText">--</span></div>
                    <button id="refreshKitchen" class="btn secondary">Refrescar</button>
                </div>
            </div>

            <div class="kanban" id="kanbanBoard">
                <div class="kanban-column" data-status="pending">
                    <div class="column-header"><strong>Pendiente</strong><span class="kol-count" id="count-pending">0</span></div>
                    <div id="col-pending"></div>
                </div>
                <div class="kanban-column" data-status="preparing">
                    <div class="column-header"><strong>En preparación</strong><span class="kol-count" id="count-preparing">0</span></div>
                    <div id="col-preparing"></div>
                </div>
                <div class="kanban-column" data-status="ready">
                    <div class="column-header"><strong>Listo</strong><span class="kol-count" id="count-ready">0</span></div>
                    <div id="col-ready"></div>
                </div>
            </div>
        </section>

        <!-- ORDERS (customer) -->
        <section id="ordersSection" style="display:none" class="panel">
            <h2 class="section-title">Historial de Pedidos</h2>
            <div class="panel" style="margin-top:12px">
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr><th>ID</th><th>Fecha</th><th>Productos</th><th>Total</th><th>Estado</th></tr>
                    </thead>
                    <tbody id="ordersTableBody"><tr><td colspan="5">Cargando...</td></tr></tbody>
                </table>
            </div>
        </section>

        <!-- ADMIN PANEL -->
        <section id="adminSection" style="display:none">
            <h2 class="section-title">Panel de Administración</h2>
            <div class="grid columns-3">
                <div class="panel">
                    <h3 style="margin-bottom:10px">Gestión de Productos</h3>
                    <form id="productForm" style="display:flex;flex-direction:column;gap:8px">
                        <input id="productName" placeholder="Nombre" required style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
                        <input id="productPrice" type="number" placeholder="Precio" required style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
                        <input id="productCategory" placeholder="Categoría" required style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
                        <textarea id="productDescription" placeholder="Descripción" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit"></textarea>
                        <div style="display:flex;gap:8px">
                            <button type="submit" class="btn">Agregar</button>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <h3>Pedidos</h3>
                    <div style="max-height:420px;overflow:auto">
                        <table class="orders-table" id="adminOrdersTable">
                            <thead><tr><th>ID</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Estado</th></tr></thead>
                            <tbody id="adminOrdersTableBody"><tr><td colspan="5">Cargando...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div class="panel">
                    <h3>Clientes</h3>
                    <div style="max-height:420px;overflow:auto">
                        <table class="orders-table" id="customersTable"><thead><tr><th>Nombre</th><th>Email</th></tr></thead><tbody id="customersTableBody"><tr><td colspan="2">Cargando...</td></tr></tbody></table>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Cart floating -->
    <div id="cartFloat" class="cart-float" title="Abrir carrito" style="display:none">
        <i class="fas fa-shopping-cart"></i>
        <div id="cartCount" style="min-width:28px;text-align:center">0</div>
        <div style="margin-left:6px">Ver carrito</div>
    </div>

    <script>
        // Firebase config (kept)
        const firebaseConfig = {
            apiKey: "AIzaSyAY9aPCtpNEv77Bmm3ITDwuwg7FPSWVHTA",
            authDomain: "arcanosweb-3a746.firebaseapp.com",
            projectId: "arcanosweb-3a746",
            storageBucket: "arcanosweb-3a746.appspot.com",
            messagingSenderId: "708200899753",
            appId: "1:708200899753:web:eafb8bf818a25fdbfd75b8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // State
        let currentUser = null;
        let currentUserRole = 'customer';
        let cart = [];
        let products = [];

        // DOM
        const authSection = document.getElementById('authSection');
        const menuSection = document.getElementById('menuSection');
        const ordersSection = document.getElementById('ordersSection');
        const adminSection = document.getElementById('adminSection');
        const kitchenSection = document.getElementById('kitchenSection');
        const cartFloat = document.getElementById('cartFloat');
        const cartCount = document.getElementById('cartCount');
        const productsContainer = document.getElementById('productsContainer');
        const authForm = document.getElementById('authForm');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const signUpBtn = document.getElementById('signUpBtn');
        const logoutBtnEl = document.getElementById('logoutBtn');
        const roleBadge = document.getElementById('roleBadge');
        const userArea = document.getElementById('userArea');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const adminOrdersTableBody = document.getElementById('adminOrdersTableBody');
        const customersTableBody = document.getElementById('customersTableBody');
        const productForm = document.getElementById('productForm');
        const productName = document.getElementById('productName');
        const productPrice = document.getElementById('productPrice');
        const productCategory = document.getElementById('productCategory');
        const productDescription = document.getElementById('productDescription');
        const kanbanCols = { pending: document.getElementById('col-pending'), preparing: document.getElementById('col-preparing'), ready: document.getElementById('col-ready') };
        const countPending = document.getElementById('count-pending'), countPreparing = document.getElementById('count-preparing'), countReady = document.getElementById('count-ready');
        const kitchenFilterText = document.getElementById('kitchenFilterText');

        // Utilities
        function showNotification(msg){ console.log(msg); alert(msg); }

        function showSection(name){
            // hide all
            [authSection, menuSection, ordersSection, adminSection, kitchenSection].forEach(s=>s.style.display='none');
            // choose
            switch(name){
                case 'auth': authSection.style.display='block'; break;
                case 'menu': menuSection.style.display='block'; break;
                case 'orders': ordersSection.style.display='block'; break;
                case 'admin': adminSection.style.display='block'; break;
                case 'kitchen': kitchenSection.style.display='block'; break;
            }
        }

        // Auth handling
        auth.onAuthStateChanged(async user=>{
            currentUser = user;
            if(user){
                // fetch customer doc for role
                const doc = await db.collection('customers').doc(user.uid).get().catch(()=>null);
                if(doc && doc.exists){
                    const data = doc.data();
                    currentUserRole = data.role || (data.isAdmin ? 'admin' : 'customer');
                } else {
                    // create default
                    await db.collection('customers').doc(user.uid).set({
                        email: user.email,
                        displayName: user.displayName || 'Cliente',
                        role: 'customer',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, {merge:true});
                    currentUserRole = 'customer';
                }

                roleBadge.textContent = currentUserRole.toUpperCase();
                userArea.textContent = (user.displayName && user.displayName[0]) || user.email[0] || 'U';
                updateUIForRole();
                await loadProducts();
                if(currentUserRole==='admin') await loadAdminOrders();
                if(currentUserRole==='customer') await loadUserOrders();
                if(currentUserRole==='mesero') { showSection('menu'); }
                if(currentUserRole.startsWith('cocina')) { showSection('kitchen'); loadKitchenOrders(); }
                // show cart float for mesero & customers
                if(['customer','mesero','admin'].includes(currentUserRole)) cartFloat.style.display='flex'; else cartFloat.style.display='none';
            } else {
                // not logged in
                currentUserRole = 'customer';
                roleBadge.textContent = '';
                userArea.textContent = 'U';
                showSection('auth');
                cartFloat.style.display='none';
            }
        });

        // Auth form
        authForm.addEventListener('submit', e=>{
            e.preventDefault();
            const email = authEmail.value; const pwd = authPassword.value;
            auth.signInWithEmailAndPassword(email,pwd)
            .then(()=>{ showNotification('Bienvenido'); authForm.reset(); })
            .catch(err=>showNotification('Error: '+err.message));
        });
        signUpBtn.addEventListener('click', async ()=>{
            const email = authEmail.value; const pwd = authPassword.value;
            if(!email || !pwd){ showNotification('Completa email y contraseña para registrarte'); return; }
            try{
                const uc = await auth.createUserWithEmailAndPassword(email,pwd);
                await db.collection('customers').doc(uc.user.uid).set({ email, displayName:'Cliente', role:'customer', createdAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
                showNotification('Cuenta creada');
            }catch(err){ showNotification('Error: '+err.message) }
        });

        logoutBtnEl.addEventListener('click', ()=> auth.signOut().then(()=>showNotification('Sesión cerrada')) );

        // Update UI per role
        function updateUIForRole(){
            // Hide/Show nav & sections per role
            // mesero: only menu + cart
            // cocina-empanadas / cocina-general: only kitchen
            // admin: everything
            if(currentUserRole === 'admin'){
                showSection('admin');
                cartFloat.style.display='flex';
            } else if(currentUserRole === 'mesero'){
                showSection('menu');
                cartFloat.style.display='flex';
            } else if(currentUserRole === 'customer'){
                showSection('menu');
                cartFloat.style.display='block';
            } else if(currentUserRole.startsWith('cocina')){
                showSection('kitchen');
                cartFloat.style.display='none';
            } else {
                showSection('menu');
            }
        }

        // Load products
        async function loadProducts(){
            const snapshot = await db.collection('products').get();
            products = [];
            snapshot.forEach(d=> products.push({ id:d.id, ...d.data()}));
            renderProducts();
        }

        function renderProducts(){
            productsContainer.innerHTML='';
            products.forEach(p=>{
                const card = document.createElement('div'); card.className='product-card';
                card.innerHTML = `
                    <div class="product-image"><img src="${p.image || 'https://via.placeholder.com/400x300?text='+encodeURIComponent(p.name)}" alt="${p.name}"></div>
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div class="product-name">${p.name}</div>
                            <div class="product-desc" style="color:var(--muted);font-size:0.9rem">${p.description || ''}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-weight:700">$${Number(p.price).toFixed(2)}</div>
                            <div class="badge" style="margin-top:8px">${p.category || 'sin categoria'}</div>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
                        <button class="btn add-to-cart" data-id="${p.id}"><i class="fas fa-plus"></i> Añadir</button>
                    </div>
                `;
                productsContainer.appendChild(card);
            });
            // attach listeners
            document.querySelectorAll('.add-to-cart').forEach(btn=>{
                btn.addEventListener('click', e=>{
                    const id = btn.dataset.id;
                    addToCart(id);
                });
            });
        }

        // Cart
        function addToCart(productId){
            const p = products.find(x=>x.id===productId);
            if(!p) return;
            const existing = cart.find(i=>i.id===productId);
            if(existing) existing.quantity++;
            else cart.push({ id:p.id, name:p.name, price:p.price, quantity:1, category:p.category });
            cartCount.textContent = cart.reduce((s,i)=>s+i.quantity,0);
            showNotification(p.name+' añadida al carrito');
        }

        cartFloat.addEventListener('click', ()=>{
            // open a simple cart prompt for quick testing
            if(cart.length===0){ alert('Carrito vacío'); return; }
            const summary = cart.map(i=>`${i.quantity} x ${i.name} = $${(i.price*i.quantity).toFixed(2)}`).join('\n');
            if(confirm('Resumen:\n'+summary+'\n\nEnviar pedido?')){
                checkout();
            }
        });

        async function checkout(){
            if(!currentUser) { showNotification('Debes iniciar sesión'); return; }
            if(cart.length===0) { showNotification('Carrito vacío'); return; }
            const subtotal = cart.reduce((s,i)=>s + (i.price * i.quantity),0);
            const order = {
                date: new Date().toISOString(),
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: currentUser.displayName || 'Cliente',
                items: cart.map(i=>({ productId: i.id, name:i.name, price:i.price, quantity:i.quantity, category:i.category })),
                subtotal,
                tax: 0,
                total: subtotal,
                status: 'pending',
                paymentMethod: 'pos',
            };
            await db.collection('orders').add(order);
            showNotification('Pedido enviado');
            cart = []; cartCount.textContent='0';
            if(currentUserRole==='admin') loadAdminOrders();
            if(currentUserRole==='customer') loadUserOrders();
        }

        // Load user orders
        async function loadUserOrders(){
            if(!currentUser) return;
            const snap = await db.collection('orders').where('userId','==',currentUser.uid).orderBy('date','desc').get();
            ordersTableBody.innerHTML='';
            if(snap.empty) ordersTableBody.innerHTML='<tr><td colspan="5">No tienes pedidos</td></tr>';
            snap.forEach(d=>{
                const o = { id:d.id, ...d.data() };
                const date = new Date(o.date).toLocaleString();
                ordersTableBody.innerHTML += `<tr><td>${o.id.substring(0,8)}</td><td>${date}</td><td>${o.items.length} productos</td><td>$${o.total.toFixed(2)}</td><td>${o.status}</td></tr>`;
            });
        }

        // Admin orders
        async function loadAdminOrders(){
            const snap = await db.collection('orders').orderBy('date','desc').get();
            adminOrdersTableBody.innerHTML='';
            if(snap.empty) adminOrdersTableBody.innerHTML='<tr><td colspan="5">No hay pedidos</td></tr>';
            snap.forEach(d=>{
                const o = { id:d.id, ...d.data() };
                const date = new Date(o.date).toLocaleString();
                adminOrdersTableBody.innerHTML += `<tr><td>${o.id.substring(0,8)}</td><td>${o.userName}</td><td>${date}</td><td>$${o.total.toFixed(2)}</td><td>${o.status}</td></tr>`;
            });
        }

        // Kitchen orders: Kanban, filtered by role
        async function loadKitchenOrders(){
            // determine filter
            let filterText = '';
            const snap = await db.collection('orders').orderBy('date','desc').get();
            const all = [];
            snap.forEach(d=> all.push({ id:d.id, ...d.data() }));
            // filter by role
            let relevant = [];
            if(currentUserRole === 'cocina-empanadas'){
                relevant = all.filter(o => o.items && o.items.some(it => (it.category || '').toLowerCase() === 'empanadas'));
                filterText = 'Empanadas';
            } else if(currentUserRole === 'cocina-general'){
                relevant = all.filter(o => !(o.items && o.items.some(it => (it.category || '').toLowerCase() === 'empanadas')));
                filterText = 'General (no empanadas)';
            } else {
                relevant = all; filterText = 'Todos';
            }
            kitchenFilterText.textContent = filterText;

            // clear columns
            Object.values(kanbanCols).forEach(c=> c.innerHTML='');

            // For any order that is 'pending' and relevant, set to 'preparing' automatically
            const updates = [];
            relevant.forEach(o=>{
                if(o.status === 'pending'){
                    updates.push(db.collection('orders').doc(o.id).update({ status: 'preparing' }).then(()=>{ o.status='preparing' }).catch(()=>{}));
                }
            });
            await Promise.all(updates);

            // Re-fetch to be consistent
            const snap2 = await db.collection('orders').orderBy('date','desc').get();
            const all2 = []; snap2.forEach(d=> all2.push({ id:d.id, ...d.data() }));
            if(currentUserRole === 'cocina-empanadas'){
                relevant = all2.filter(o => o.items && o.items.some(it => (it.category || '').toLowerCase() === 'empanadas'));
            } else if(currentUserRole === 'cocina-general'){
                relevant = all2.filter(o => !(o.items && o.items.some(it => (it.category || '').toLowerCase() === 'empanadas')));
            } else {
                relevant = all2;
            }

            // render into columns
            const colMap = { pending:[], preparing:[], ready:[] };
            relevant.forEach(o=>{
                const s = o.status || 'pending';
                if(!colMap[s]) colMap[s]=[];
                colMap[s].push(o);
            });

            // helper to create card
            function createCard(o){
                const div = document.createElement('div'); div.className='order-card';
                const date = new Date(o.date).toLocaleString();
                const itemLines = (o.items || []).map(it=>`${it.quantity}x ${it.name}`).join(', ');
                div.innerHTML = `
                    <div class="order-meta">
                        <div><strong>#${o.id.substring(0,6)}</strong> · ${date}</div>
                        <div><span class="status-pill ${o.status==='pending'?'status-pending':o.status==='preparing'?'status-preparing':'status-ready'}">${o.status}</span></div>
                    </div>
                    <div class="order-items">${itemLines}</div>
                    <div style="font-weight:700">$${(o.total||o.subtotal||0).toFixed(2)}</div>
                    <div class="order-actions" style="margin-top:8px">
                        ${ o.status === 'preparing' ? `<button class="btn mark-ready" data-id="${o.id}">Marcar Listo</button>` : '' }
                        <button class="btn secondary view-details" data-id="${o.id}">Ver</button>
                    </div>
                `;
                // attach events later
                return div;
            }

            // append
            ['pending','preparing','ready'].forEach(status=>{
                const arr = colMap[status] || [];
                const container = kanbanCols[status];
                arr.forEach(o=>{
                    const card = createCard(o);
                    container.appendChild(card);
                });
            });

            // update counters
            countPending.textContent = (colMap.pending||[]).length;
            countPreparing.textContent = (colMap.preparing||[]).length;
            countReady.textContent = (colMap.ready||[]).length;

            // attach mark-ready events
            document.querySelectorAll('.mark-ready').forEach(b=>{
                b.addEventListener('click', async (e)=>{
                    const id = b.dataset.id;
                    await db.collection('orders').doc(id).update({ status: 'ready' });
                    showNotification('Pedido marcado como listo');
                    loadKitchenOrders();
                });
            });

            document.querySelectorAll('.view-details').forEach(b=>{
                b.addEventListener('click', async (e)=>{
                    const id = b.dataset.id;
                    const doc = await db.collection('orders').doc(id).get();
                    if(doc.exists){
                        const o = doc.data();
                        alert('Pedido '+id+'\\n\\n'+(o.items||[]).map(it=>`${it.quantity} x ${it.name}`).join('\\n'));
                    }
                });
            });
        }

        // refresh kitchen
        document.getElementById('refreshKitchen').addEventListener('click', loadKitchenOrders);

        // product form
        productForm.addEventListener('submit', async (e)=>{
            e.preventDefault();
            if(!productName.value || !productPrice.value) return showNotification('Completa nombre y precio');
            await db.collection('products').add({ name:productName.value, price:parseFloat(productPrice.value), description:productDescription.value, category:productCategory.value });
            productForm.reset(); loadProducts(); showNotification('Producto agregado');
        });

        // initial load of customers (for admin)
        async function loadCustomers(){
            const snap = await db.collection('customers').get();
            customersTableBody.innerHTML='';
            snap.forEach(d=>{
                const c = d.data();
                customersTableBody.innerHTML += `<tr><td>${c.displayName||'Cliente'}</td><td>${c.email||''}</td></tr>`;
            });
        }

        // Periodic refresh for kitchen (optional)
        setInterval(()=>{
            if(currentUserRole.startsWith('cocina')) loadKitchenOrders();
            if(currentUserRole==='admin') loadAdminOrders();
            if(currentUserRole==='customer') loadUserOrders();
        }, 30000);

        // expose some helpers for console testing
        window._reload = loadKitchenOrders;
        window._loadProducts = loadProducts;

    </script>
</body>
</html>
