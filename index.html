<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcanos Lunch | Sabor Vibrante</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Nueva Tipografía: Poppins para títulos, Inter para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Paleta "Sabor Vibrante" */
            --primary: #F97316;      /* Naranja principal, más audaz */
            --primary-dark: #EA580C;
            --accent: #FBBF24;       /* Amarillo cálido como acento */
            
            --bg-light: #FFFFFF;     /* Fondo principal blanco */
            --bg-off-white: #F9FAFB; /* Fondo secundario muy claro */
            
            --text-dark: #1F2937;     /* Texto principal oscuro */
            --text-gray: #6B7280;     /* Texto secundario gris */
            
            --border-color: #E5E7EB; /* Bordes y divisores */

            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;

            /* Tipografía */
            --font-body: 'Inter', sans-serif;
            --font-display: 'Poppins', sans-serif; /* Nueva fuente para títulos */

            /* Sombras y Efectos */
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Otros */
            --border-radius: 0.75rem;
            --transition: all 0.2s ease-in-out;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-off-white);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: 80px;
            padding-bottom: 80px;
        }
        
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 700; color: var(--text-dark); }
        .section-title { font-size: 2rem; margin-bottom: 2.5rem; text-align: center; }

        /* --- LOGIN --- */
        #authSection {
            display: flex; justify-content: center; align-items: center;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; padding: 1rem;
            background-color: var(--bg-off-white);
            z-index: 2000; transition: opacity 0.3s ease-in-out;
        }
        .auth-container {
            width: 100%; max-width: 420px;
            background: var(--bg-light);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeInScale 0.4s ease-out forwards;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .auth-header { text-align: center; padding: 2.5rem 2rem 1.5rem; background-color: var(--primary); color: white; }
        .auth-header i { font-size: 3rem; }
        .auth-header h2 { font-size: 1.75rem; color: white; }
        #authMessage { font-size: 1rem; opacity: 0.9; margin-top: 0.5rem; }
        .auth-body { padding: 2rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 0.75rem 1rem;
            border: 1px solid var(--border-color); border-radius: var(--border-radius);
            font-size: 1rem; transition: var(--transition); background: var(--bg-off-white);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--primary); box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); outline: none;
        }
        .btn-primary {
            width: 100%; background-color: var(--primary); color: white; border: none;
            padding: 0.875rem; border-radius: var(--border-radius);
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: var(--transition); box-shadow: var(--shadow);
        }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .auth-footer { padding: 0 2rem 2rem; text-align: center; }
        .auth-links a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .separator {
            display: flex; align-items: center; text-align: center;
            color: var(--text-gray); font-size: 0.875rem; margin: 1.5rem 0;
        }
        .separator::before, .separator::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
        .separator:not(:empty)::before { margin-right: .5em; }
        .separator:not(:empty)::after { margin-left: .5em; }
        
        /* --- NUEVO ESTILO DE BOTONES SOCIALES --- */
        .auth-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-light);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.5rem;
        }
        .social-btn:hover {
            border-color: var(--text-gray);
            background-color: var(--bg-off-white);
        }
        .fa-google { color: #DB4437; }
        .fa-apple { color: #1F2937; }
        /* --- FIN NUEVO ESTILO --- */
        
        /* --- HEADER & NAV --- */
        #mainHeader {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0; z-index: 900;
            transform: translateY(-100%); transition: transform 0.3s ease-out;
        }
        #mainHeader.visible { transform: translateY(0); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .menu-toggle { background: none; border: none; font-size: 1.25rem; color: var(--text-dark); cursor: pointer; }
        .logo { font-family: var(--font-display); font-size: 1.5rem; color: var(--text-dark); text-decoration: none; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .cart-btn { position: relative; background: none; border: none; font-size: 1.25rem; color: var(--text-dark); cursor: pointer; }
        .cart-count {
            position: absolute; top: -5px; right: -8px; background-color: var(--primary); color: white;
            border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
        }
        .logout-btn {
            background: var(--bg-off-white); color: var(--text-dark);
            border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: var(--border-radius);
            font-weight: 600; cursor: pointer; transition: var(--transition);
        }
        .logout-btn:hover { background: var(--primary); border-color: var(--primary); color: white; }

        #magicNav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-light);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around;
            padding: 0.5rem 0; z-index: 1000;
            transform: translateY(100%); transition: transform 0.3s ease-out;
        }
        #magicNav.visible { transform: translateY(0); }
        .magic-nav-item {
            display: flex; flex-direction: column; align-items: center;
            text-decoration: none; color: var(--text-gray);
            font-size: 0.75rem; font-weight: 500;
            padding: 0.5rem; border-radius: var(--border-radius);
            transition: var(--transition); width: 64px; position: relative;
        }
        .magic-nav-item.active { color: var(--primary); }
        .magic-nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .magic-nav-item .cart-count { top: -2px; right: 12px; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: 0; left: -280px; width: 280px;
            height: 100%; background: var(--bg-light);
            z-index: 1100; box-shadow: var(--shadow-lg);
            transition: transform 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(280px); }
        .sidebar-header { padding: 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { font-size: 1.2rem; }
        .close-sidebar { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-gray); }
        .categories-container { padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .category-btn {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; border-radius: var(--border-radius);
            text-decoration: none; color: var(--text-dark); font-weight: 500;
            transition: var(--transition);
        }
        .category-btn:hover { background-color: var(--bg-off-white); }
        .category-btn.active { background-color: var(--primary); color: white; }
        .category-btn i { width: 20px; text-align: center; }
        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); z-index: 1050;
            transition: opacity 0.3s; opacity: 0;
        }
        .overlay.active { display: block; opacity: 1; }

        /* --- PRODUCT CARD --- */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .product-card {
            background: var(--bg-light); border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden; transition: var(--transition);
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .product-image { height: 180px; background: var(--border-color); }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 1.25rem; }
        .product-category {
            font-size: 0.75rem; font-weight: 600; color: var(--text-dark);
            margin-bottom: 0.75rem; text-transform: uppercase;
            background-color: var(--accent); display: inline-block;
            padding: 0.25rem 0.75rem; border-radius: 2rem;
        }
        .product-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .product-description { color: var(--text-gray); font-size: 0.875rem; margin-bottom: 1rem; min-height: 40px; }
        .product-footer { display: flex; justify-content: space-between; align-items: center; }
        .product-price { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .add-to-cart {
            background-color: var(--primary); color: white; border: none; 
            padding: 0.6rem 1.2rem; border-radius: var(--border-radius);
            cursor: pointer; font-weight: 600; transition: var(--transition);
        }
        .add-to-cart:hover { background-color: var(--primary-dark); }

        /* --- ORDER VIEWS --- */
        .order-filter-controls { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; justify-content: center; flex-wrap: wrap; }
        .filter-btn {
            padding: 0.5rem 1rem; background: var(--bg-light);
            border: 1px solid var(--border-color); border-radius: 2rem;
            cursor: pointer; transition: var(--transition); font-weight: 500; color: var(--text-gray);
        }
        .filter-btn.active, .filter-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .order-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .empty-list-message { color: var(--text-gray); text-align: center; padding: 2rem 0; font-style: italic; grid-column: 1 / -1; }
        .order-card {
            background: var(--bg-light); border-radius: var(--border-radius);
            box-shadow: var(--shadow); padding: 1rem; border-left: 4px solid;
        }
        
        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(29, 41, 55, 0.5); z-index: 1500; justify-content: center; align-items: center; }
        .modal.visible { display: flex; }
        .modal-content {
            background: var(--bg-light); border-radius: var(--border-radius);
            width: 90%; max-width: 500px; max-height: 90vh;
            display: flex; flex-direction: column; box-shadow: var(--shadow-lg);
        }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; } .modal-header h3 { font-size: 1.25rem; } .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; } .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); text-align: right; } .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-gray); }
        
        /* --- WAITER TABLE VIEW --- */
        .table-card {
            background: var(--bg-light); border-radius: var(--border-radius);
            padding: 1rem; text-align: center; cursor: pointer;
            transition: var(--transition); box-shadow: var(--shadow);
            border: 2px solid transparent;
        }
        .table-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .table-card.active { border-color: var(--primary); background: var(--primary); color: white; }
        .table-card.locked { background: var(--border-color); color: var(--text-gray); cursor: not-allowed; opacity: 0.8; }
        .table-card.active i, .table-card.active span { color: white; }

        /* --- PROFILE CARD --- */
        .profile-card {
            max-width: 500px; margin: 2rem auto; background: var(--bg-light);
            padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow);
        }
        .profile-avatar { background: var(--primary); color: white; }
        .detail-item { border-bottom: 1px solid var(--border-color); }

        /* --- ADMIN PANEL --- */
        .admin-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .admin-tab-btn { padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--text-gray); position: relative; }
        .admin-tab-btn.active { color: var(--primary); }
        .admin-tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary); }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .admin-card { background: var(--bg-light); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 800px; margin: 0 auto; }
        .employee-list { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;}
        .employee-item { display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .employee-info p { margin: 0; }
        .employee-info .email { font-size: 0.875rem; color: var(--text-gray); }
        .btn-secondary { background-color: var(--bg-off-white); color: var(--text-dark); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: var(--transition); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: var(--danger); color: white; }
        .employee-filter-controls { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        
        /* === ESTILOS MEJORADOS PARA LA LISTA DE PRODUCTOS EN ADMIN (GRID LAYOUT) === */
        #adminProductList { display: flex; flex-direction: column; gap: 0.75rem; }
        .admin-product-list-header, .admin-product-list-item {
            display: grid;
            grid-template-columns: 2.5fr 3fr 1fr 100px; /* Nombre, Desc, Precio, Acciones */
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
        }
        .admin-product-list-header {
            font-weight: 600;
            color: var(--text-gray);
            font-size: 0.875rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            display: none; /* Oculto por defecto, visible en pantallas grandes */
        }
        .admin-product-list-item {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        .admin-product-list-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        .admin-product-name { font-weight: 600; }
        .admin-product-desc, .admin-product-price { color: var(--text-gray); font-size: 0.9rem; }
        .admin-product-desc {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Corta el texto largo con '...' */
        }
        .admin-product-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }

        @media (min-width: 768px) {
            .admin-product-list-header {
                display: grid; /* Muestra los encabezados en pantallas de tablet o más grandes */
            }
        }


        /* ... (El resto del CSS se mantiene similar) ... */
        .order-card.status-pending { border-color: var(--warning); } .order-card.status-preparing { border-color: #3B82F6; } .order-card.status-ready { border-color: var(--success); } .order-card.status-paid { border-color: var(--accent); } .order-card.status-cancelled { border-color: var(--text-gray); }
        .item-status { padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-pending { background-color: var(--warning); } .status-preparing { background-color: #3B82F6; } .status-ready { background-color: var(--success); } .status-paid { background-color: var(--accent); } .status-cancelled { background-color: var(--text-gray); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; } .order-header h4 { font-size: 1.125rem; } .order-header span { font-size: 0.875rem; color: var(--text-gray); }
        .order-items { border-top: 1px solid var(--border-color); padding-top: 0.75rem; } .order-item { display: flex; justify-content: space-between; font-size: 0.875rem; padding: 0.25rem 0; } .order-item span:first-child { color: var(--text-gray); } .order-actions { margin-top: 1rem; text-align: right; }
        .table-selection { margin-bottom: 2rem; } .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; } .table-card i { font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--primary); transition: var(--transition); } .table-card.locked i { color: var(--text-gray); } .table-card span { font-weight: 600; }
        .profile-header { text-align: center; margin-bottom: 1.5rem; } .profile-header h3 { font-size: 1.5rem; } .profile-header p { color: var(--text-gray); } .profile-details { display: flex; flex-direction: column; gap: 1rem; } .detail-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); } .detail-item:last-child { border-bottom: none; } .detail-item span:first-child { font-weight: 500; color: var(--text-dark); } .detail-item span:last-child { color: var(--text-gray); }
        .notification { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: var(--text-dark); color: white; padding: 0.75rem 1.5rem; border-radius: 2rem; box-shadow: var(--shadow-lg); z-index: 2000; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
        .notification.show { opacity: 1; transform: translate(-50%, -10px); }
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <!-- Header Fijo -->
    <header id="mainHeader">
        <div class="container header-content">
            <div class="header-left">
                <button id="menuToggle" class="menu-toggle" style="display: none;"><i class="fas fa-bars"></i></button>
                <a href="#" class="logo">Arcanos</a>
            </div>
            <div class="header-actions">
                <button id="desktopCartBtn" class="cart-btn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </button>
                <button id="logoutBtn" class="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar de Categorías -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Categorías</h3>
            <button class="close-sidebar" id="closeSidebar"><i class="fas fa-times"></i></button>
        </div>
        <div class="categories-container" id="categoriesContainer"></div>
    </aside>
    <div class="overlay" id="overlay"></div>
    
    <!-- Contenido Principal -->
    <main class="container">
        <!-- Login (se superpone a todo) -->
        <section id="authSection" style="display: none;">
            <div class="auth-container">
                <div class="auth-header">
                    <i class="fas fa-drumstick-bite"></i>
                    <h2>Arcanos Lunch</h2>
                    <p id="authMessage">Bienvenido de nuevo</p>
                </div>
                <div class="auth-body">
                    <form id="authForm" class="auth-form">
                        <div class="form-group"><label for="authEmail">Correo</label><input type="email" id="authEmail" required></div>
                        <div class="form-group"><label for="authPassword">Contraseña</label><input type="password" id="authPassword" required></div>
                        <div id="confirmPasswordField" style="display: none;" class="form-group"><label for="authConfirmPassword">Confirmar Contraseña</label><input type="password" id="authConfirmPassword"></div>
                        <button type="submit" class="btn-primary" id="authSubmitBtn">Iniciar Sesión</button>
                    </form>
                </div>
                <div class="auth-footer">
                    <div class="auth-links">
                        <a href="#" id="signUpLink">Crear cuenta</a><span id="linkSeparator" style="margin:0 .5rem">·</span><a href="#" id="forgotPasswordLink">Olvidé contraseña</a><a href="#" id="loginLink" style="display:none">Volver a login</a>
                    </div>
                    <div class="separator">o continúa con</div>
                    <!-- NUEVA ESTRUCTURA DE BOTONES SOCIALES -->
                    <div class="auth-options">
                        <button class="social-btn" id="googleLogin" title="Continuar con Google"><i class="fab fa-google"></i></button>
                        <button class="social-btn" id="appleLogin" title="Continuar con Apple"><i class="fab fa-apple"></i></button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Secciones de la App -->
        <section id="menuSection" style="display: none;"><h2 class="section-title">Nuestro Menú</h2><div class="products-grid" id="productsContainer"></div></section>
        <section id="ordersSection" style="display: none;"><h2 class="section-title">Mis Pedidos</h2><div class="order-filter-controls" id="waiterFilterControls"></div><div class="order-list-container" id="waiterOrdersContainer"></div></section>
        <section id="profileSection" style="display: none;"><h2 class="section-title">Mi Perfil</h2><div id="profileContainer"></div></section>
        
        <!-- === SECCIÓN DE ADMIN MODIFICADA === -->
        <section id="adminSection" style="display: none;">
            <h2 class="section-title">Panel de Administración</h2>
            <div class="admin-tabs" id="adminTabs">
                <button class="admin-tab-btn active" data-tab="menu">Gestionar Menú</button>
                <button class="admin-tab-btn" data-tab="employees">Gestionar Empleados</button>
            </div>

            <!-- Contenido Pestaña Menú -->
            <div id="admin-tab-menu" class="admin-tab-content active">
                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Lista de Productos</h3>
                        <button class="btn-primary" id="addNewProductBtn" style="width: auto;">Añadir Nuevo</button>
                    </div>
                    <div id="adminProductList">
                        <!-- La lista de productos del admin se cargará aquí -->
                    </div>
                </div>
            </div>

            <!-- Contenido Pestaña Empleados -->
            <div id="admin-tab-employees" class="admin-tab-content">
                 <div class="admin-card">
                    <h3>Gestionar Roles de Empleados</h3>
                    <div class="employee-filter-controls" id="employeeFilterControls">
                        <button class="filter-btn active" data-filter="employees">Ver Empleados</button>
                        <button class="filter-btn" data-filter="customers">Ver Clientes</button>
                    </div>
                    <div id="employeeListStatus"></div>
                    <div class="employee-list" id="employeeList">
                        <!-- La lista de empleados se cargará aquí -->
                    </div>
                </div>
            </div>
        </section>
        <!-- === FIN SECCIÓN ADMIN === -->

        <section id="waiterSection" style="display: none;"><div class="table-selection" id="tableSelection"></div><h2 class="section-title" id="waiterMenuTitle" style="display:none;"></h2><div class="products-grid" id="waiterProductsContainer"></div></section>
        <section id="chefSection" style="display: none;"><h2 class="section-title">Panel de Cocina</h2><div class="order-filter-controls" id="chefFilterControls"></div><div class="order-list-container" id="kitchenOrdersContainer"></div></section>
        <section id="cashierSection" style="display: none;"><h2 class="section-title">Panel de Caja</h2><div class="order-filter-controls" id="cashierFilterControls"></div><div class="order-list-container" id="cashierOrdersContainer"></div></section>
    </main>

    <!-- Modal del Carrito -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Tu Carrito</h3><button class="close-modal">&times;</button></div>
            <div class="modal-body" id="cartItemsContainer"></div>
            <div class="modal-footer"><button id="checkoutBtn" class="btn-primary">Finalizar Compra</button><button id="processOrderBtn" class="btn-primary" style="display:none;">Procesar Pedido</button></div>
        </div>
    </div>
    
    <!-- === MODAL PARA PRODUCTOS (AÑADIR/EDITAR) === -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Añadir Nuevo Producto</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label for="productName">Nombre del Producto</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Categoría</label>
                        <input type="text" id="productCategory" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Precio</label>
                        <input type="number" id="productPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Descripción</label>
                        <textarea id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="productImage">Imagen del Producto</label>
                        <input type="file" id="productImage" accept="image/*">
                        <input type="hidden" id="existingImageUrl">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveProductBtn" class="btn-primary">Guardar Producto</button>
            </div>
        </div>
    </div>

    <!-- Navegación Inferior -->
    <nav class="magic-nav" id="magicNav"></nav>
    
    <!-- Notificación -->
    <div class="notification" id="notification"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAY9aPCtpNEv77Bmm3ITDwuwg7FPSWVHTA",
            authDomain: "arcanosweb-3a746.firebaseapp.com",
            projectId: "arcanosweb-3a746",
            storageBucket: "arcanosweb-3a746.appspot.com",
            messagingSenderId: "708200899753",
            appId: "1:708200899753:web:eafb8bf818a25fdbfd75b8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null, currentUserRole = 'customer', currentCategory = 'all';
        let products = [], allOrders = [], cart = [], cartByTable = {};
        let currentTable = null, realtimeOrdersListener = null;
        let chefFilter = 'pending', cashierFilter = 'ready', waiterFilter = 'active';

        // --- DOM Elements ---
        const mainHeader = document.getElementById('mainHeader');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const magicNav = document.getElementById('magicNav');
        const allSections = document.querySelectorAll('main > section');
        const productsContainer = document.getElementById('productsContainer');
        const waiterOrdersContainer = document.getElementById('waiterOrdersContainer');
        const kitchenOrdersContainer = document.getElementById('kitchenOrdersContainer');
        const cashierOrdersContainer = document.getElementById('cashierOrdersContainer');
        const notification = document.getElementById('notification');
        
        // Carts
        const cartModal = document.getElementById('cartModal');
        const desktopCartBtn = document.getElementById('desktopCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const processOrderBtn = document.getElementById('processOrderBtn');

        // Auth
        const authForm = document.getElementById('authForm'), authEmail = document.getElementById('authEmail'), authPassword = document.getElementById('authPassword'), authConfirmPassword = document.getElementById('authConfirmPassword'), confirmPasswordField = document.getElementById('confirmPasswordField'), authSubmitBtn = document.getElementById('authSubmitBtn'), authMessage = document.getElementById('authMessage'), signUpLink = document.getElementById('signUpLink'), forgotPasswordLink = document.getElementById('forgotPasswordLink'), loginLink = document.getElementById('loginLink'), googleLoginBtn = document.getElementById('googleLogin'), appleLoginBtn = document.getElementById('appleLogin'), linkSeparator = document.getElementById('linkSeparator');
        let authMode = 'login';
        
        // Sidebar
        const sidebar = document.getElementById('sidebar'), overlay = document.getElementById('overlay'), menuToggle = document.getElementById('menuToggle'), closeSidebar = document.getElementById('closeSidebar'), categoriesContainer = document.getElementById('categoriesContainer');

        // Product Modal
        const productModal = document.getElementById('productModal');

        // --- Auth State ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                authSection.style.opacity = '0';
                setTimeout(() => authSection.style.display = 'none', 300);
                mainHeader.classList.add('visible');
                magicNav.classList.add('visible');
                
                db.collection("customers").doc(user.uid).get().then(doc => {
                    currentUserRole = doc.exists ? (doc.data().role || 'customer') : 'customer';
                    if (!doc.exists) saveCustomerData(user);
                    loadInitialDataForRole();
                });
                loadProducts();
            } else {
                authSection.style.display = 'flex';
                setTimeout(() => authSection.style.opacity = '1', 50);
                mainHeader.classList.remove('visible');
                magicNav.classList.remove('visible');
                allSections.forEach(s => { if(s.id !== 'authSection') s.style.display = 'none'; });
                if (realtimeOrdersListener) realtimeOrdersListener();
                setAuthMode('login');
            }
        });

        function saveCustomerData(user) {
            db.collection("customers").doc(user.uid).set({
                uid: user.uid, email: user.email,
                displayName: user.displayName || "Cliente",
                role: 'customer',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        function setAuthMode(mode) {
            authMode = mode;
            authForm.reset();
            const isLogin = mode === 'login', isRegister = mode === 'register';
            confirmPasswordField.style.display = isRegister ? 'block' : 'none';
            signUpLink.style.display = isLogin ? 'inline' : 'none';
            forgotPasswordLink.style.display = isLogin ? 'inline' : 'none';
            linkSeparator.style.display = isLogin ? 'inline' : 'none';
            loginLink.style.display = !isLogin ? 'inline' : 'none';
            authMessage.textContent = isLogin ? "Bienvenido de nuevo" : (isRegister ? "Crea tu cuenta" : "Recupera tu acceso");
            authSubmitBtn.textContent = isLogin ? "Iniciar Sesión" : (isRegister ? "Registrarse" : "Enviar enlace");
        }
        
        // --- UI & Navigation ---
        function showSection(sectionId) {
            allSections.forEach(s => s.style.display = 'none');
            const targetSection = document.getElementById(`${sectionId}Section`);
            if (targetSection) targetSection.style.display = 'block';
            
            document.querySelectorAll('.magic-nav-item').forEach(item => {
                let itemSection = item.dataset.section;
                if (currentUserRole === 'waiter' && itemSection === 'menu') itemSection = 'waiter';
                if (currentUserRole.includes('chef')) itemSection = 'chef';
                item.classList.toggle('active', itemSection === sectionId);
            });
        }

        function updateUIForRole() {
            const navConfig = {
                customer: [{i:'fa-store', t:'Menú', s:'menu'}, {i:'fa-receipt', t:'Pedidos', s:'orders'}, {i:'fa-user', t:'Perfil', s:'profile'}],
                waiter: [{i:'fa-concierge-bell', t:'Mesas', s:'waiter'}, {i:'fa-receipt', t:'Pedidos', s:'orders'}],
                chef: [{i:'fa-hat-chef', t:'Cocina', s:'chef'}],
                cashier: [{i:'fa-cash-register', t:'Caja', s:'cashier'}],
                admin: [{i:'fa-cogs', t:'Admin', s:'admin'}]
            };
            const roleKey = currentUserRole.includes('chef') ? 'chef' : currentUserRole;
            magicNav.innerHTML = (navConfig[roleKey] || []).map(item => 
                `<a href="#" class="magic-nav-item" data-section="${item.s}"><i class="fas ${item.i}"></i><span>${item.t}</span></a>`
            ).join('');
            
            if (['customer', 'waiter'].includes(currentUserRole)) {
                magicNav.innerHTML += `<a href="#" class="magic-nav-item" data-section="cart"><i class="fas fa-shopping-cart"></i><span class="cart-count">0</span></a>`;
            }

            document.querySelectorAll('.magic-nav-item').forEach(item => item.addEventListener('click', e => {
                e.preventDefault();
                const section = item.dataset.section;
                if (section === 'cart') openCartModal();
                else showSection(section);
            }));

            desktopCartBtn.style.display = ['customer', 'waiter'].includes(currentUserRole) ? 'block' : 'none';
            menuToggle.style.display = currentUserRole === 'customer' ? 'block' : 'none';
            logoutBtn.style.display = 'block';
        }

        function loadInitialDataForRole() {
            updateUIForRole();
            if (realtimeOrdersListener) realtimeOrdersListener();
            const roleToAction = {
                waiter: () => { showSection('waiter'); listenForTableLocks(); listenForWaiterOrders(); renderWaiterProducts(); },
                chef: () => { showSection('chef'); listenForKitchenOrders(); },
                cashier: () => { showSection('cashier'); listenForCashierOrders(); },
                admin: () => { showSection('admin'); setupAdminPanel(); },
                customer: () => { showSection('menu'); listenForWaiterOrders(); renderProfile(); }
            };
            const action = roleToAction[currentUserRole.includes('chef') ? 'chef' : currentUserRole] || roleToAction.customer;
            action();
            setupFilterControls();
        }

        // === ADMIN PANEL FUNCTIONS ===
        function setupAdminPanel() {
            const tabs = document.getElementById('adminTabs');
            const contents = document.querySelectorAll('.admin-tab-content');
            const employeeFilters = document.getElementById('employeeFilterControls');
            
            tabs.addEventListener('click', (e) => {
                if(e.target.tagName !== 'BUTTON') return;

                tabs.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');

                contents.forEach(content => content.classList.remove('active'));
                const targetContent = document.getElementById(`admin-tab-${e.target.dataset.tab}`);
                targetContent.classList.add('active');
                
                if (e.target.dataset.tab === 'menu') {
                    loadAdminProducts();
                } else if(e.target.dataset.tab === 'employees') {
                    loadEmployees('employees'); 
                    employeeFilters.querySelector('.active').classList.remove('active');
                    employeeFilters.querySelector('[data-filter="employees"]').classList.add('active');
                }
            });

            employeeFilters.addEventListener('click', (e) => {
                if(e.target.tagName !== 'BUTTON') return;
                employeeFilters.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                loadEmployees(e.target.dataset.filter);
            });

            document.getElementById('addNewProductBtn').addEventListener('click', () => openProductModal());
            document.getElementById('saveProductBtn').addEventListener('click', handleProductFormSubmit);
            
            // Cargar la vista por defecto (lista de productos)
            loadAdminProducts();
        }

        // --- Product CRUD Functions (Admin) ---
        async function loadAdminProducts() {
            const container = document.getElementById('adminProductList');
            container.innerHTML = `<p>Cargando productos...</p>`;
            try {
                const snapshot = await db.collection('products').orderBy('name').get();
                const productList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (productList.length === 0) {
                    container.innerHTML = `<p class="empty-list-message">No hay productos en el menú.</p>`;
                    return;
                }
                
                const headerHTML = `
                    <div class="admin-product-list-header">
                        <div>Producto</div>
                        <div>Descripción</div>
                        <div>Precio</div>
                        <div style="text-align: right;">Acciones</div>
                    </div>`;

                const productsHTML = productList.map(p => `
                    <div class="admin-product-list-item" id="admin-product-${p.id}">
                        <div class="admin-product-name">${p.name}</div>
                        <div class="admin-product-desc" title="${p.description || ''}">${p.description || '-'}</div>
                        <div class="admin-product-price">$${p.price.toFixed(2)}</div>
                        <div class="admin-product-actions">
                            <button class="btn-secondary edit-product-btn" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn-secondary btn-danger delete-product-btn" data-id="${p.id}" data-image="${p.imageUrl || ''}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = headerHTML + productsHTML;

                container.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', e => openProductModal(e.currentTarget.dataset.id)));
                container.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', e => handleDeleteProduct(e.currentTarget.dataset.id, e.currentTarget.dataset.image)));

            } catch (error) {
                console.error("Error loading admin products:", error);
                container.innerHTML = `<p class="empty-list-message" style="color:var(--danger)">Error al cargar productos.</p>`;
            }
        }

        async function openProductModal(productId = null) {
            const form = document.getElementById('productForm');
            form.reset();
            document.getElementById('productId').value = '';
            document.getElementById('existingImageUrl').value = '';

            const modalTitle = document.getElementById('productModalTitle');
            if (productId) {
                modalTitle.textContent = 'Editar Producto';
                const doc = await db.collection('products').doc(productId).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('productId').value = productId;
                    document.getElementById('productName').value = data.name;
                    document.getElementById('productCategory').value = data.category;
                    document.getElementById('productPrice').value = data.price;
                    document.getElementById('productDescription').value = data.description || '';
                    document.getElementById('existingImageUrl').value = data.imageUrl || '';
                }
            } else {
                modalTitle.textContent = 'Añadir Nuevo Producto';
            }
            productModal.classList.add('visible');
        }

        async function handleProductFormSubmit() {
            const btn = document.getElementById('saveProductBtn');
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const productId = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value;
            const imageFile = document.getElementById('productImage').files[0];
            let imageUrl = document.getElementById('existingImageUrl').value || '';

            try {
                if (imageFile) {
                    const imageRef = storage.ref(`product_images/${Date.now()}_${imageFile.name}`);
                    const snapshot = await imageRef.put(imageFile);
                    imageUrl = await snapshot.ref.getDownloadURL();
                }

                const productData = { name, category, price, description, imageUrl };

                if (productId) {
                    await db.collection('products').doc(productId).update(productData);
                    showNotification('Producto actualizado con éxito');
                } else {
                    await db.collection('products').add(productData);
                    showNotification('Producto añadido con éxito');
                }
                
                productModal.classList.remove('visible');
                loadProducts(); // Recargar productos para la vista de cliente/mesero
                loadAdminProducts(); // Recargar lista en el panel de admin
            } catch (error) {
                console.error("Error saving product: ", error);
                showNotification('Error al guardar el producto', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Guardar Producto';
            }
        }

        async function handleDeleteProduct(productId, imageUrl) {
            if (!confirm(`¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer.`)) {
                return;
            }

            try {
                // Eliminar documento de Firestore
                await db.collection('products').doc(productId).delete();

                // Si hay una URL de imagen y no es un placeholder, eliminar de Storage
                if (imageUrl && imageUrl.includes('firebasestorage')) {
                    const imageRef = storage.refFromURL(imageUrl);
                    await imageRef.delete();
                }

                showNotification('Producto eliminado con éxito.');
                loadProducts(); // Recargar productos para la vista de cliente/mesero
                
                // Eliminar el elemento de la lista del admin visualmente
                const itemToRemove = document.getElementById(`admin-product-${productId}`);
                if (itemToRemove) {
                    itemToRemove.style.transition = 'opacity 0.3s ease';
                    itemToRemove.style.opacity = '0';
                    setTimeout(() => itemToRemove.remove(), 300);
                }

            } catch (error) {
                console.error("Error deleting product:", error);
                showNotification('Error al eliminar el producto.', 'error');
            }
        }
        
        // --- Employee CRUD Functions (Admin) ---
        async function loadEmployees(filter = 'employees') {
            const container = document.getElementById('employeeList');
            const statusDiv = document.getElementById('employeeListStatus');
            container.innerHTML = '';
            statusDiv.innerHTML = '<p>Cargando...</p>';

            const employeeRoles = ['waiter', 'chef', 'cashier', 'admin'];

            try {
                let query;
                if (filter === 'employees') {
                    query = db.collection('customers').where('role', 'in', employeeRoles);
                } else { // filter === 'customers'
                    query = db.collection('customers').where('role', '==', 'customer');
                }
                
                const snapshot = await query.get();
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (users.length === 0) {
                    statusDiv.innerHTML = `<p class="empty-list-message">No se encontraron ${filter}.</p>`;
                    return;
                }
                
                statusDiv.innerHTML = '';
                container.innerHTML = users.map(user => `
                    <div class="employee-item" data-id="${user.id}">
                        <div class="employee-info">
                            <p><strong>${user.displayName || 'Sin Nombre'}</strong></p>
                            <p class="email">${user.email}</p>
                        </div>
                        <select class="role-select">
                            <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>Cliente</option>
                            <option value="waiter" ${user.role === 'waiter' ? 'selected' : ''}>Mesero</option>
                            <option value="chef" ${user.role.includes('chef') ? 'selected' : ''}>Cocinero</option>
                            <option value="cashier" ${user.role === 'cashier' ? 'selected' : ''}>Cajero</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <button class="btn-secondary save-role-btn">Guardar</button>
                    </div>
                `).join('');

                container.querySelectorAll('.save-role-btn').forEach(btn => {
                    btn.addEventListener('click', handleRoleUpdate);
                });

            } catch (error) {
                console.error("Error loading users: ", error);
                statusDiv.innerHTML = `<p class="empty-list-message" style="color: var(--danger);">Error al cargar: ${error.message}</p>`;
            }
        }

        async function handleRoleUpdate(e) {
            const item = e.target.closest('.employee-item');
            const userId = item.dataset.id;
            const newRole = item.querySelector('.role-select').value;
            
            e.target.disabled = true;
            e.target.textContent = '...';

            try {
                await db.collection('customers').doc(userId).update({ role: newRole });
                showNotification('Rol actualizado con éxito.');
                
                const activeFilter = document.querySelector('#employeeFilterControls .filter-btn.active').dataset.filter;
                const employeeRoles = ['waiter', 'chef', 'cashier', 'admin'];
                const isEmployee = employeeRoles.includes(newRole);

                if ((activeFilter === 'employees' && !isEmployee) || (activeFilter === 'customers' && isEmployee)) {
                    item.style.transition = 'opacity 0.3s ease';
                    item.style.opacity = '0';
                    setTimeout(() => item.remove(), 300);
                }

            } catch (error) {
                console.error("Error updating role: ", error);
                showNotification('Error al actualizar el rol.', 'error');
            } finally {
                e.target.disabled = false;
                e.target.textContent = 'Guardar';
            }
        }

        // --- Product & Category Functions (Customer/Waiter) ---
        function loadProducts() {
            db.collection("products").get().then(snapshot => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategoryFilters();
                renderProducts();
                renderWaiterProducts();
            });
        }
        function renderCategoryFilters() {
            const categories = [...new Set(products.map(p => p.category))];
            categoriesContainer.innerHTML = `<a href="#" class="category-btn active" data-category="all"><i class="fas fa-utensils"></i><span>Todos</span></a>` +
                categories.map(cat => `<a href="#" class="category-btn" data-category="${cat}"><i class="fas fa-tag"></i><span>${cat}</span></a>`).join('');
            categoriesContainer.querySelectorAll('.category-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.preventDefault();
                filterProductsByCategory(btn.dataset.category);
            }));
        }
        function filterProductsByCategory(category) {
            currentCategory = category;
            renderProducts();
            categoriesContainer.querySelector('.active').classList.remove('active');
            categoriesContainer.querySelector(`[data-category="${category}"]`).classList.add('active');
            closeSidebarFunc();
        }
        function renderProducts() {
            if (!productsContainer) return;
            let filtered = (currentCategory === 'all') ? products : products.filter(p => p.category === currentCategory);
            productsContainer.innerHTML = filtered.map(createProductCard).join('');
            productsContainer.querySelectorAll('.add-to-cart').forEach(b => b.addEventListener('click', e => addToCart(e.currentTarget.dataset.id)));
        }
        function createProductCard(p) {
            const imageUrl = p.imageUrl || `https://via.placeholder.com/300x200?text=${p.name.replace(/\s+/g, '+')}`;
            return `<div class="product-card">
                        <div class="product-image"><img src="${imageUrl}" alt="${p.name}"></div>
                        <div class="product-info">
                            <p class="product-category">${p.category}</p>
                            <h3 class="product-title">${p.name}</h3>
                            <p class="product-description">${p.description || ''}</p>
                            <div class="product-footer">
                                <span class="product-price">$${p.price.toFixed(2)}</span>
                                <button class="add-to-cart" data-id="${p.id}"><i class="fas fa-plus"></i> Añadir</button>
                            </div>
                        </div>
                    </div>`;
        }

        // --- Order & Notification Functions ---
        function listenForWaiterOrders() {
            const query = db.collection("orders").where('waiterId', "==", currentUser.uid);
            realtimeOrdersListener = query.onSnapshot(snapshot => {
                // NOTIFICATION LOGIC: Check for status changes made by chef
                snapshot.docChanges().forEach(change => {
                    if (change.type === "modified") {
                        const oldData = change.doc.data();
                        const newData = change.doc.data();
                        if (oldData.status !== 'ready' && newData.status === 'ready') {
                            showNotification(`¡El pedido de la Mesa ${newData.table} está listo!`);
                        }
                    }
                });

                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                renderFilteredOrders(waiterOrdersContainer, waiterFilter);
            }, console.error);
        }

        function listenForKitchenOrders() {
            const query = db.collection("orders");
            realtimeOrdersListener = query.onSnapshot(snapshot => {
                // NOTIFICATION LOGIC: Check for new pending orders
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && change.doc.data().status === 'pending') {
                        const order = change.doc.data();
                        showNotification(`Nuevo pedido para la ${order.table ? `Mesa ${order.table}` : 'cliente'}`);
                    }
                });
                
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => new Date(a.date) - new Date(b.date));
                renderFilteredOrders(kitchenOrdersContainer, chefFilter);
            }, console.error);
        }

        function listenForCashierOrders() {
            const query = db.collection("orders");
            realtimeOrdersListener = query.onSnapshot(snapshot => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => new Date(b.date) - new Date(a.date));
                renderFilteredOrders(cashierOrdersContainer, cashierFilter);
            }, console.error);
        }

        function renderFilteredOrders(container, filter) {
            if (!container) return;
            const statusMap = { active: ['pending', 'preparing', 'ready'], history: ['paid', 'cancelled'] };
            const targetStatuses = statusMap[filter] || [filter];
            const filtered = allOrders.filter(order => targetStatuses.includes(order.status));
            
            container.innerHTML = filtered.length === 0 ? '<p class="empty-list-message">No hay pedidos.</p>' : filtered.map(createOrderCard).join('');
            setupCardActions(container);
        }
        function createOrderCard(order) {
            let actions = '';
            if (currentUserRole.includes('chef')) {
                if (order.status === 'pending') actions = `<button class="btn-primary" data-action="prepare" data-id="${order.id}">Preparar</button>`;
                if (order.status === 'preparing') actions = `<button class="btn-primary" style="background-color: var(--success);" data-action="ready" data-id="${order.id}">Listo</button>`;
            } else if (currentUserRole === 'cashier' && order.status === 'ready') {
                actions = `<button class="btn-primary" data-action="pay" data-id="${order.id}">Marcar Pagado</button>`;
            }
            return `<div class="order-card status-${order.status}">
                        <div class="order-header">
                            <div><h4>Pedido #${order.id.slice(-6)}</h4><span>${order.table ? `Mesa ${order.table}` : (order.userName || 'Cliente')}</span></div>
                            <span class="item-status status-${order.status}">${getStatusText(order.status)}</span>
                        </div>
                        <div class="order-items">${(order.items || []).map(it => `<div class="order-item"><span>${it.quantity}x</span> <span>${it.name}</span></div>`).join('')}</div>
                        ${actions ? `<div class="order-actions">${actions}</div>` : ''}
                    </div>`;
        }
        function setupCardActions(container) {
            if (!container) return;
            container.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                const { action, id } = target.dataset;
                if(action === 'prepare') updateOrderStatus(id, 'preparing');
                if(action === 'ready') updateOrderStatus(id, 'ready');
                if(action === 'pay') updateOrderStatus(id, 'paid');
            });
        }
        function updateOrderStatus(orderId, status) {
            db.collection("orders").doc(orderId).update({ status }).then(() => showNotification("Estado actualizado")).catch(err => showNotification('Error al actualizar', 'error'));
        }

        // --- Cart Functions ---
        function getActiveCart() {
            if (currentUserRole === 'waiter') {
                if (!currentTable) { showNotification('Seleccione una mesa', 'error'); return null; }
                if (!cartByTable[currentTable]) cartByTable[currentTable] = [];
                return cartByTable[currentTable];
            }
            return cart;
        }
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const activeCart = getActiveCart();
            if (!product || !activeCart) return;
            const item = activeCart.find(i => i.id === productId);
            if (item) item.quantity++;
            else activeCart.push({ ...product, quantity: 1 });
            showNotification(`${product.name} añadido`);
            updateCartCount();
        }
        function updateCartCount() {
            const activeCart = getActiveCart();
            const count = activeCart ? activeCart.reduce((sum, item) => sum + item.quantity, 0) : 0;
            document.querySelectorAll('.cart-count').forEach(el => el.textContent = count);
        }
        function openCartModal() {
            renderCart();
            cartModal.classList.add('visible');
            const isWaiter = currentUserRole === 'waiter';
            checkoutBtn.style.display = isWaiter ? 'none' : 'block';
            processOrderBtn.style.display = isWaiter ? 'block' : 'none';
        }
        function closeCartModal() {
            cartModal.classList.remove('visible');
        }
        function renderCart() {
            const container = document.getElementById('cartItemsContainer');
            const activeCart = getActiveCart();
            if (!container || !activeCart) return;

            if (!activeCart || activeCart.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-gray);">Tu carrito está vacío.</p>';
                return;
            }
            container.innerHTML = activeCart.map(item => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding: 0.5rem 0;">
                    <div><p style="font-weight:600;">${item.name}</p><p style="font-size:0.875rem; color:var(--text-gray);">$${item.price.toFixed(2)}</p></div><div>${item.quantity}</div>
                </div>`).join('');
        }
        async function processWaiterOrder() {
            const activeCart = getActiveCart();
            if (!activeCart || activeCart.length === 0 || !currentTable) return showNotification('Seleccione mesa y añada productos.', 'error');
            const order = {
                date: new Date().toISOString(), waiterId: currentUser.uid,
                userName: `Mesa ${currentTable}`, items: activeCart,
                total: activeCart.reduce((s, i) => s + (i.price * i.quantity), 0),
                status: 'pending', table: currentTable
            };
            try {
                await db.collection("orders").add(order);
                showNotification(`Pedido para Mesa ${currentTable} enviado.`);
                cartByTable[currentTable] = [];
                document.querySelector('.table-card.active')?.classList.remove('active');
                currentTable = null;
                updateCartCount();
                closeCartModal();
            } catch (error) { showNotification('Error al guardar el pedido', 'error'); }
        }
        async function checkout() {
            if (cart.length === 0) return showNotification('El carrito está vacío', 'error');
            const order = {
                date: new Date().toISOString(), userId: currentUser.uid,
                userName: currentUser.displayName, items: cart,
                total: cart.reduce((s, i) => s + (i.price * i.quantity), 0),
                status: 'pending',
            };
            try {
                await db.collection("orders").add(order);
                showNotification(`Pedido enviado con éxito.`);
                cart = [];
                updateCartCount();
                closeCartModal();
            } catch (error) { showNotification('Error al guardar el pedido', 'error'); }
        }

        // --- Waiter Specific Functions ---
        function listenForTableLocks() {
            const tableContainer = document.getElementById('tableSelection');
            if(!tableContainer) return;
            tableContainer.innerHTML = '<h2 class="section-title">Seleccione una Mesa</h2><div class="tables-grid">' + 
            [...Array(10)].map((_, i) => `<div class="table-card" data-table="${i+1}"><i class="fas fa-utensils"></i><span>Mesa ${i+1}</span></div>`).join('') + '</div>';

            tableContainer.addEventListener('click', e => {
                const card = e.target.closest('.table-card');
                if (!card || card.classList.contains('locked')) return;
                tableContainer.querySelector('.active')?.classList.remove('active');
                card.classList.add('active');
                currentTable = card.dataset.table;
                const menuTitle = document.getElementById('waiterMenuTitle');
                menuTitle.textContent = `Menú para la Mesa ${currentTable}`;
                menuTitle.style.display = 'block';
            });

            db.collection("orders").where("status", "in", ["pending", "preparing", "ready"]).onSnapshot(snapshot => {
                const lockedTables = new Set(snapshot.docs.map(doc => doc.data().table));
                tableContainer.querySelectorAll('.table-card').forEach(card => card.classList.toggle('locked', lockedTables.has(card.dataset.table)));
            });
        }
        function renderWaiterProducts() {
            const container = document.getElementById('waiterProductsContainer');
            if (!container) return;
            container.innerHTML = products.map(createProductCard).join('');
            container.querySelectorAll('.add-to-cart').forEach(b => b.addEventListener('click', e => addToCart(e.currentTarget.dataset.id)));
        }

        // --- Other Functions ---
        function renderProfile() {
            const container = document.getElementById('profileContainer');
            if (!container || !currentUser) return;
            const creationDate = currentUser.metadata.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleDateString() : 'N/A';
            container.innerHTML = `
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">${(currentUser.displayName || 'C').charAt(0)}</div>
                        <h3>${currentUser.displayName || 'Cliente'}</h3>
                        <p>${currentUser.email}</p>
                    </div>
                    <div class="profile-details">
                        <div class="detail-item"><span>Miembro desde</span> <span>${creationDate}</span></div>
                        <div class="detail-item"><span>Pedidos totales</span> <span id="profileOrderCount">0</span></div>
                    </div>
                </div>`;
            db.collection('orders').where('userId', '==', currentUser.uid).get().then(s => {
                const countEl = document.getElementById('profileOrderCount');
                if(countEl) countEl.textContent = s.size;
            });
        }
        
        function getStatusText(status) {
            const texts = { pending: 'Entrante', preparing: 'En preparación', ready: 'Listo', paid: 'Pagado', cancelled: 'Cancelado' };
            return texts[status] || status;
        }
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--text-dark)';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }
        function openSidebarFunc() { sidebar.classList.add('open'); overlay.classList.add('active'); }
        function closeSidebarFunc() { sidebar.classList.remove('open'); overlay.classList.remove('active'); }
        
        function setupFilterControls() {
            const configs = [
                { id: 'waiterFilterControls', container: waiterOrdersContainer, filterVar: 'waiterFilter', buttons: [{t:'Activos', s:'active'}, {t:'Historial', s:'history'}] },
                { id: 'chefFilterControls', container: kitchenOrdersContainer, filterVar: 'chefFilter', buttons: [{t:'Entrantes', s:'pending'}, {t:'En Preparación', s:'preparing'}, {t:'Listos', s:'ready'}] },
                { id: 'cashierFilterControls', container: cashierOrdersContainer, filterVar: 'cashierFilter', buttons: [{t:'Listos para Pagar', s:'ready'}, {t:'Pagados', s:'paid'}] },
            ];
            configs.forEach(config => {
                const controls = document.getElementById(config.id);
                if (!controls) return;
                controls.innerHTML = config.buttons.map(b => `<button class="filter-btn ${window[config.filterVar] === b.s ? 'active' : ''}" data-status="${b.s}">${b.t}</button>`).join('');
                controls.addEventListener('click', e => {
                    const target = e.target.closest('.filter-btn');
                    if (!target) return;
                    window[config.filterVar] = target.dataset.status;
                    controls.querySelector('.active')?.classList.remove('active');
                    target.classList.add('active');
                    renderFilteredOrders(config.container, window[config.filterVar]);
                });
            });
        }

        // --- Global Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = authEmail.value, password = authPassword.value;
                authSubmitBtn.disabled = true;
                authSubmitBtn.textContent = 'Procesando...';
                if (authMode === 'login') auth.signInWithEmailAndPassword(email, password).catch(handleAuthError);
                else if (authMode === 'register') {
                    if (password !== authConfirmPassword.value) { handleAuthError({ message: "Las contraseñas no coinciden." }); return; }
                    auth.createUserWithEmailAndPassword(email, password).catch(handleAuthError);
                } else if (authMode === 'forgot') {
                    auth.sendPasswordResetEmail(email).then(() => { showNotification("Correo de recuperación enviado."); setAuthMode('login'); }).catch(handleAuthError);
                }
            });
            function handleAuthError(error) {
                showNotification(`Error: ${error.message}`, 'error');
                setAuthMode(authMode);
                authSubmitBtn.disabled = false;
            }
            signUpLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('register'); });
            forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('forgot'); });
            loginLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('login'); });
            googleLoginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(handleAuthError));
            appleLoginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.OAuthProvider('apple.com')).catch(handleAuthError));

            desktopCartBtn.addEventListener('click', openCartModal);
            cartModal.querySelector('.close-modal')?.addEventListener('click', closeCartModal);
            productModal.querySelector('.close-modal')?.addEventListener('click', () => productModal.classList.remove('visible'));
            logoutBtn.addEventListener('click', () => auth.signOut());
            checkoutBtn.addEventListener('click', checkout);
            processOrderBtn.addEventListener('click', processWaiterOrder);
            menuToggle.addEventListener('click', openSidebarFunc);
            closeSidebar.addEventListener('click', closeSidebarFunc);
            overlay.addEventListener('click', closeSidebarFunc);
        });
    </script>
</body>
</html>