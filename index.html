<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcanos Lunch | Sabor Vibrante</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Nueva Tipografía: Poppins para títulos, Inter para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Paleta "Sabor Vibrante" */
            --primary: #F97316;      /* Naranja principal, más audaz */
            --primary-dark: #EA580C;
            --accent: #FBBF24;       /* Amarillo cálido como acento */
            
            --bg-light: #FFFFFF;     /* Fondo principal blanco */
            --bg-off-white: #F9FAFB; /* Fondo secundario muy claro */
            
            --text-dark: #1F2937;     /* Texto principal oscuro */
            --text-gray: #6B7280;     /* Texto secundario gris */
            
            --border-color: #E5E7EB; /* Bordes y divisores */

            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;

            /* Tipografía */
            --font-body: 'Inter', sans-serif;
            --font-display: 'Poppins', sans-serif; /* Nueva fuente para títulos */

            /* Sombras y Efectos */
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Otros */
            --border-radius: 0.75rem;
            --transition: all 0.2s ease-in-out;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-off-white);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: 80px;
            padding-bottom: 80px;
        }
        
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 700; color: var(--text-dark); }
        .section-title { font-size: 2rem; margin-bottom: 2.5rem; text-align: center; }

        /* --- LOGIN --- */
        #authSection {
            display: flex; justify-content: center; align-items: center;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; padding: 1rem;
            background-color: var(--bg-off-white);
            z-index: 2000; transition: opacity 0.3s ease-in-out;
        }
        .auth-container {
            width: 100%; max-width: 420px;
            background: var(--bg-light);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeInScale 0.4s ease-out forwards;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .auth-header { text-align: center; padding: 2.5rem 2rem 1.5rem; background-color: var(--primary); color: white; }
        .auth-header i { font-size: 3rem; }
        .auth-header h2 { font-size: 1.75rem; color: white; }
        #authMessage { font-size: 1rem; opacity: 0.9; margin-top: 0.5rem; }
        .auth-body { padding: 2rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 0.75rem 1rem;
            border: 1px solid var(--border-color); border-radius: var(--border-radius);
            font-size: 1rem; transition: var(--transition); background: var(--bg-off-white);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--primary); box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); outline: none;
        }
        .btn-primary {
            width: 100%; background-color: var(--primary); color: white; border: none;
            padding: 0.875rem; border-radius: var(--border-radius);
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: var(--transition); box-shadow: var(--shadow);
        }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .auth-footer { padding: 0 2rem 2rem; text-align: center; }
        .auth-links a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .separator {
            display: flex; align-items: center; text-align: center;
            color: var(--text-gray); font-size: 0.875rem; margin: 1.5rem 0;
        }
        .separator::before, .separator::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
        .separator:not(:empty)::before { margin-right: .5em; }
        .separator:not(:empty)::after { margin-left: .5em; }
        
        /* --- NUEVO ESTILO DE BOTONES SOCIALES --- */
        .auth-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-light);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.5rem;
        }
        .social-btn:hover {
            border-color: var(--text-gray);
            background-color: var(--bg-off-white);
        }
        .fa-google { color: #DB4437; }
        .fa-apple { color: #1F2937; }
        /* --- FIN NUEVO ESTILO --- */
        
        /* --- HEADER & NAV --- */
        #mainHeader {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0; z-index: 900;
            transform: translateY(-100%); transition: transform 0.3s ease-out;
        }
        #mainHeader.visible { transform: translateY(0); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .menu-toggle { background: none; border: none; font-size: 1.25rem; color: var(--text-dark); cursor: pointer; }
        .logo { font-family: var(--font-display); font-size: 1.5rem; color: var(--text-dark); text-decoration: none; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .cart-btn { position: relative; background: none; border: none; font-size: 1.25rem; color: var(--text-dark); cursor: pointer; }
        .cart-count {
            position: absolute; top: -5px; right: -8px; background-color: var(--primary); color: white;
            border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
        }
        .logout-btn {
            background: var(--bg-off-white); color: var(--text-dark);
            border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: var(--border-radius);
            font-weight: 600; cursor: pointer; transition: var(--transition);
        }
        .logout-btn:hover { background: var(--primary); border-color: var(--primary); color: white; }

        #magicNav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-light);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around;
            padding: 0.5rem 0; z-index: 1000;
            transform: translateY(100%); transition: transform 0.3s ease-out;
        }
        #magicNav.visible { transform: translateY(0); }
        .magic-nav-item {
            display: flex; flex-direction: column; align-items: center;
            text-decoration: none; color: var(--text-gray);
            font-size: 0.75rem; font-weight: 500;
            padding: 0.5rem; border-radius: var(--border-radius);
            transition: var(--transition); width: 64px; position: relative;
        }
        .magic-nav-item.active { color: var(--primary); }
        .magic-nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .magic-nav-item .cart-count { top: -2px; right: 12px; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: 0; left: -280px; width: 280px;
            height: 100%; background: var(--bg-light);
            z-index: 1100; box-shadow: var(--shadow-lg);
            transition: transform 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(280px); }
        .sidebar-header { padding: 1.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { font-size: 1.2rem; }
        .close-sidebar { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-gray); }
        .categories-container { padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .category-btn {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; border-radius: var(--border-radius);
            text-decoration: none; color: var(--text-dark); font-weight: 500;
            transition: var(--transition);
        }
        .category-btn:hover { background-color: var(--bg-off-white); }
        .category-btn.active { background-color: var(--primary); color: white; }
        .category-btn i { width: 20px; text-align: center; }
        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); z-index: 1050;
            transition: opacity 0.3s; opacity: 0;
        }
        .overlay.active { display: block; opacity: 1; }

        /* --- PRODUCT CARD --- */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .product-card {
            background: var(--bg-light); border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden; transition: var(--transition);
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .product-image { height: 180px; background: var(--border-color); }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 1.25rem; }
        .product-category {
            font-size: 0.75rem; font-weight: 600; color: var(--text-dark);
            margin-bottom: 0.75rem; text-transform: uppercase;
            background-color: var(--accent); display: inline-block;
            padding: 0.25rem 0.75rem; border-radius: 2rem;
        }
        .product-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .product-description { color: var(--text-gray); font-size: 0.875rem; margin-bottom: 1rem; min-height: 40px; }
        .product-footer { display: flex; justify-content: space-between; align-items: center; }
        .product-price { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .add-to-cart {
            background-color: var(--primary); color: white; border: none; 
            padding: 0.6rem 1.2rem; border-radius: var(--border-radius);
            cursor: pointer; font-weight: 600; transition: var(--transition);
        }
        .add-to-cart:hover { background-color: var(--primary-dark); }

        /* --- ORDER VIEWS --- */
        .order-filter-controls { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; justify-content: center; flex-wrap: wrap; }
        .filter-btn {
            padding: 0.5rem 1rem; background: var(--bg-light);
            border: 1px solid var(--border-color); border-radius: 2rem;
            cursor: pointer; transition: var(--transition); font-weight: 500; color: var(--text-gray);
        }
        .filter-btn.active, .filter-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .order-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .empty-list-message { color: var(--text-gray); text-align: center; padding: 2rem 0; font-style: italic; grid-column: 1 / -1; }
        .order-card {
            background: var(--bg-light); border-radius: var(--border-radius);
            box-shadow: var(--shadow); padding: 1.25rem; border-left: 4px solid;
        }
        
        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(29, 41, 55, 0.5); z-index: 1500; justify-content: center; align-items: center; }
        .modal.visible { display: flex; }
        .modal-content {
            background: var(--bg-light); border-radius: var(--border-radius);
            width: 90%; max-width: 500px; max-height: 90vh;
            display: flex; flex-direction: column; box-shadow: var(--shadow-lg);
        }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; } .modal-header h3 { font-size: 1.25rem; } .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; } .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); text-align: right; } .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-gray); }
        
        /* --- WAITER TABLE VIEW --- */
        .table-card {
            background: var(--bg-light); border-radius: var(--border-radius);
            padding: 1rem; text-align: center; cursor: pointer;
            transition: var(--transition); box-shadow: var(--shadow);
            border: 2px solid transparent;
        }
        .table-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .table-card.active { border-color: var(--primary); background: var(--primary); color: white; }
        .table-card.locked { background: var(--border-color); color: var(--text-gray); cursor: not-allowed; opacity: 0.8; }
        .table-card.active i, .table-card.active span { color: white; }

        /* --- PROFILE CARD --- */
        .profile-card {
            max-width: 500px; margin: 2rem auto; background: var(--bg-light);
            padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow);
        }
        .profile-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-family: var(--font-display);
            margin: 0 auto 1rem;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .detail-item:last-of-type { border-bottom: none; }
        .detail-item span:first-child { font-weight: 600; color: var(--text-dark); margin-right: 1rem; }
        .detail-item span:last-child { color: var(--text-gray); text-align: right; }


        /* --- ADMIN PANEL --- */
        .admin-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; flex-wrap: wrap; }
        .admin-tab-btn { padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--text-gray); position: relative; }
        .admin-tab-btn.active { color: var(--primary); }
        .admin-tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary); }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .admin-card { background: var(--bg-light); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 800px; margin: 0 auto; }
        .employee-list { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;}
        .employee-item { display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .employee-info p { margin: 0; }
        .employee-info .email { font-size: 0.875rem; color: var(--text-gray); }
        .btn-secondary { background-color: var(--bg-off-white); color: var(--text-dark); border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: var(--transition); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: var(--danger); color: white; }
        .employee-filter-controls { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        
        /* === ESTILOS PARA LA LISTA DE PRODUCTOS EN ADMIN === */
        #adminProductList { display: flex; flex-direction: column; gap: 0.75rem; }
        .admin-product-list-header, .admin-product-list-item {
            display: grid;
            grid-template-columns: 2.5fr 3fr 1fr 100px; /* Nombre, Desc, Precio, Acciones */
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
        }
        .admin-product-list-header {
            font-weight: 600; color: var(--text-gray); font-size: 0.875rem;
            border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;
            display: none; /* Oculto por defecto, visible en pantallas grandes */
        }
        .admin-product-list-item {
            background-color: var(--bg-light); border: 1px solid var(--border-color);
            border-radius: var(--border-radius); transition: var(--transition);
        }
        .admin-product-list-item:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .admin-product-name { font-weight: 600; }
        .admin-product-desc, .admin-product-price { color: var(--text-gray); font-size: 0.9rem; }
        .admin-product-desc { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .admin-product-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
        
        /* === ESTILOS PARA PAGOS === */
        .payment-methods { margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
        #pagoMovilDetails { display: none; margin-top: 1rem; }
        #pagoMovilInfo { background: var(--bg-off-white); border: 1px dashed var(--border-color); border-radius: var(--border-radius); padding: 1rem; margin-top: 1rem; font-size: 0.875rem; }
        #pagoMovilInfo p { margin: 0.25rem 0; }
        #pagoMovilInfo strong { color: var(--text-dark); }
        
        /* === NUEVOS ESTILOS PARA ADMIN PAGOS === */
        #pagoMovilList { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }
        .payment-method-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background-color: var(--bg-off-white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        .payment-method-info p { margin: 0; line-height: 1.4; }
        .payment-method-info .bank { font-weight: 600; }
        .payment-method-info .details { font-size: 0.9rem; color: var(--text-gray); }
        .payment-method-actions { display: flex; gap: 0.5rem; }
        
        /* ESTILOS PARA FORMULARIO DE NUEVO USUARIO */
        .form-row { display: flex; gap: 1rem; }
        .form-row .form-group { flex: 1; }
        #newUserSetupForm a {
            color: var(--primary);
            text-decoration: underline;
            font-weight: 600;
            cursor: pointer;
        }

        /* === NUEVOS ESTILOS PARA TRACKING DE PEDIDO === */
        .order-tracker {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            margin: 1.5rem 0 1rem;
        }
        .order-tracker::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 4px;
            background-color: var(--border-color);
            z-index: 1;
        }
        .tracker-progress {
            position: absolute;
            top: 12px;
            left: 10%;
            height: 4px;
            background-color: var(--primary);
            z-index: 2;
            transition: width 0.4s ease;
        }
        .tracker-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 80px;
            z-index: 3;
        }
        .tracker-step .icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--border-color);
            color: var(--text-gray);
            border: 4px solid var(--bg-light);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            transition: var(--transition);
        }
        .tracker-step .label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-gray);
            margin-top: 0.5rem;
        }
        .tracker-step.completed .icon, .tracker-step.active .icon {
            background-color: var(--primary);
            color: white;
        }
        .tracker-step.active .label {
            color: var(--primary);
            font-weight: 700;
        }

        @media (min-width: 768px) { .admin-product-list-header { display: grid; } }

        .order-card.status-pending { border-color: var(--warning); } .order-card.status-preparing { border-color: #3B82F6; } .order-card.status-ready { border-color: var(--success); } .order-card.status-assigned { border-color: #8B5CF6; } .order-card.status-en_camino { border-color: var(--primary); } .order-card.status-delivered_pending_cashier { border-color: #D946EF; } .order-card.status-paid { border-color: var(--accent); } .order-card.status-cancelled { border-color: var(--text-gray); }
        .item-status { padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-pending { background-color: var(--warning); } .status-preparing { background-color: #3B82F6; } .status-ready { background-color: var(--success); } .status-assigned { background-color: #8B5CF6; } .status-en_camino { background-color: var(--primary); } .status-delivered_pending_cashier { background-color: #D946EF; } .status-paid { background-color: var(--accent); } .status-cancelled { background-color: var(--text-gray); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; } .order-header h4 { font-size: 1.125rem; } .order-header span { font-size: 0.875rem; color: var(--text-gray); }
        .order-items { border-top: 1px solid var(--border-color); padding-top: 0.75rem; } .order-item { display: flex; justify-content: space-between; font-size: 0.875rem; padding: 0.25rem 0; } .order-item span:first-child { color: var(--text-gray); } .order-actions { margin-top: 1rem; text-align: right; }
        .table-selection { margin-bottom: 2rem; } .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; } .table-card i { font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--primary); transition: var(--transition); } .table-card.locked i { color: var(--text-gray); } .table-card span { font-weight: 600; }
        .profile-header { text-align: center; margin-bottom: 1.5rem; } .profile-header h3 { font-size: 1.5rem; } .profile-header p { color: var(--text-gray); } .profile-details { display: flex; flex-direction: column; gap: 1rem; }
        .notification { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: var(--text-dark); color: white; padding: 0.75rem 1.5rem; border-radius: 2rem; box-shadow: var(--shadow-lg); z-index: 2000; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
        .notification.show { opacity: 1; transform: translate(-50%, -10px); }
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <!-- Header Fijo -->
    <header id="mainHeader">
        <div class="container header-content">
            <div class="header-left">
                <button id="menuToggle" class="menu-toggle" style="display: none;"><i class="fas fa-bars"></i></button>
                <a href="#" class="logo">Arcanos</a>
            </div>
            <div class="header-actions">
                <button id="desktopCartBtn" class="cart-btn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </button>
                <button id="logoutBtn" class="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar de Categorías -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Categorías</h3>
            <button class="close-sidebar" id="closeSidebar"><i class="fas fa-times"></i></button>
        </div>
        <div class="categories-container" id="categoriesContainer"></div>
    </aside>
    <div class="overlay" id="overlay"></div>
    
    <!-- Contenido Principal -->
    <main class="container">
        <!-- Login (se superpone a todo) -->
        <section id="authSection" style="display: none;">
            <div class="auth-container">
                <div class="auth-header">
                    <i class="fas fa-drumstick-bite"></i>
                    <h2>Arcanos Lunch</h2>
                    <p id="authMessage">Bienvenido de nuevo</p>
                </div>
                <div class="auth-body">
                    <form id="authForm" class="auth-form" novalidate>
                        <div class="form-group"><label for="authEmail">Correo</label><input type="email" id="authEmail" required></div>
                        <div class="form-group" id="passwordField"><label for="authPassword">Contraseña</label><input type="password" id="authPassword" required></div>
                        <div id="confirmPasswordField" style="display: none;" class="form-group"><label for="authConfirmPassword">Confirmar Contraseña</label><input type="password" id="authConfirmPassword"></div>
                        <button type="submit" class="btn-primary" id="authSubmitBtn">Iniciar Sesión</button>
                    </form>
                </div>
                <div class="auth-footer">
                    <div class="auth-links">
                        <a href="#" id="signUpLink">Crear cuenta</a><span id="linkSeparator" style="margin:0 .5rem">·</span><a href="#" id="forgotPasswordLink">Olvidé contraseña</a><a href="#" id="loginLink" style="display:none">Volver a login</a>
                    </div>
                    <div class="separator">o continúa con</div>
                    <div class="auth-options">
                        <button class="social-btn" id="googleLogin" title="Continuar con Google"><i class="fab fa-google"></i></button>
                        <button class="social-btn" id="appleLogin" title="Continuar con Apple"><i class="fab fa-apple"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <!-- === NUEVA SECCIÓN: CONFIGURACIÓN INICIAL DE USUARIO === -->
        <section id="newUserSetupSection" style="display: none;">
            <div class="admin-card" style="max-width: 600px; margin-top: 2rem;">
                <h2 class="section-title" style="margin-bottom: 1.5rem;">Datos de Usuario</h2>
                <p style="text-align: center; color: var(--text-gray); margin-bottom: 2rem;">¡Bienvenido! Por favor, completa tus datos para poder usar el servicio de delivery.</p>
                <form id="newUserSetupForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userFirstName">Nombre</label>
                            <input type="text" id="userFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="userLastName">Apellido</label>
                            <input type="text" id="userLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="userAddress">Dirección Completa</label>
                        <textarea id="userAddress" rows="3" required placeholder="Ej: Calle 123, Edificio ABC, Apto 4, Ciudad"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="userPhone">Número de Contacto</label>
                        <input type="tel" id="userPhone" required>
                        <p style="font-size: 0.8rem; color: var(--text-gray); margin-top: 0.25rem;">Este número se usará para coordinar el delivery.</p>
                    </div>
                     <div class="form-group" style="display: flex; align-items: center; gap: 0.75rem;">
                        <input type="checkbox" id="userTerms" required style="width: auto; height: auto;">
                        <label for="userTerms" style="margin-bottom: 0; font-weight: 400;">He leído y acepto los <a id="openTermsLink">Términos y Condiciones</a>.</label>
                    </div>
                    <button type="submit" class="btn-primary" id="saveUserSetupBtn">Crear Cuenta y Continuar</button>
                </form>
            </div>
        </section>

        <!-- Secciones de la App -->
        <section id="menuSection" style="display: none;"><h2 class="section-title">Nuestro Menú</h2><div class="products-grid" id="productsContainer"></div></section>
        <section id="ordersSection" style="display: none;"><h2 class="section-title">Mis Pedidos</h2><div class="order-filter-controls" id="waiterFilterControls"></div><div class="order-list-container" id="waiterOrdersContainer"></div></section>
        <section id="profileSection" style="display: none;"><h2 class="section-title">Mi Perfil</h2><div id="profileContainer"></div></section>
        
        <!-- === SECCIÓN DE ADMIN === -->
        <section id="adminSection" style="display: none;">
            <h2 class="section-title">Panel de Administración</h2>
            <div class="admin-tabs" id="adminTabs">
                <button class="admin-tab-btn active" data-tab="menu">Gestionar Menú</button>
                <button class="admin-tab-btn" data-tab="employees">Gestionar Empleados</button>
                <button class="admin-tab-btn" data-tab="payment">Métodos de Pago</button>
            </div>

            <!-- Contenido Pestaña Menú -->
            <div id="admin-tab-menu" class="admin-tab-content active">
                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>Lista de Productos</h3>
                        <button class="btn-primary" id="addNewProductBtn" style="width: auto;">Añadir Nuevo</button>
                    </div>
                    <div id="adminProductList"></div>
                </div>
            </div>

            <!-- Contenido Pestaña Empleados -->
            <div id="admin-tab-employees" class="admin-tab-content">
                 <div class="admin-card">
                    <h3>Gestionar Roles y Estado de Empleados</h3>
                    <div class="employee-filter-controls" id="employeeFilterControls">
                        <button class="filter-btn active" data-filter="employees">Ver Empleados</button>
                        <button class="filter-btn" data-filter="customers">Ver Clientes</button>
                    </div>
                    <div id="employeeListStatus"></div>
                    <div class="employee-list" id="employeeList"></div>
                </div>
            </div>

            <!-- Contenido Pestaña Métodos de Pago -->
            <div id="admin-tab-payment" class="admin-tab-content">
                <div class="admin-card">
                    <h3>Métodos de Pago Móvil</h3>
                    <p>Gestiona las cuentas de Pago Móvil disponibles para los clientes.</p>
                    
                    <div id="pagoMovilList" style="margin-top: 1.5rem;"></div>

                    <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                    <h4 id="paymentMethodFormTitle" style="margin-bottom: 1rem;">Añadir Nuevo Método</h4>
                    <form id="paymentMethodForm">
                        <input type="hidden" id="paymentMethodId">
                        <div class="form-group">
                            <label for="pagoMovilBank">Entidad Bancaria (Ej: Banesco, Mercantil)</label>
                            <input type="text" id="pagoMovilBank" required>
                        </div>
                        <div class="form-group">
                            <label for="pagoMovilPhone">Número de Teléfono</label>
                            <input type="text" id="pagoMovilPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="pagoMovilRif">RIF / C.I. del Titular</label>
                            <input type="text" id="pagoMovilRif" required>
                        </div>
                        <button type="submit" id="savePaymentMethodBtn" class="btn-primary">Guardar Método de Pago</button>
                        <button type="button" id="cancelEditPaymentBtn" class="btn-secondary" style="display: none; width: 100%; margin-top: 0.5rem;">Cancelar Edición</button>
                    </form>
                </div>
            </div>
        </section>
        <!-- === FIN SECCIÓN ADMIN === -->

        <section id="waiterSection" style="display: none;"><div class="table-selection" id="tableSelection"></div><h2 class="section-title" id="waiterMenuTitle" style="display:none;"></h2><div class="products-grid" id="waiterProductsContainer"></div></section>
        <section id="chefSection" style="display: none;"><h2 class="section-title">Panel de Cocina</h2><div class="order-filter-controls" id="chefFilterControls"></div><div class="order-list-container" id="kitchenOrdersContainer"></div></section>
        
        <!-- === SECCIÓN DE CAJERO MEJORADA === -->
        <section id="cashierSection" style="display: none;">
            <h2 class="section-title">Panel de Caja</h2>
            <div class="order-filter-controls" id="cashierFilterControls"></div>
            <div class="order-list-container" id="cashierOrdersContainer"></div>
        </section>

        <!-- === NUEVA SECCIÓN DE DELIVERY === -->
        <section id="deliverySection" style="display: none;">
            <h2 class="section-title">Mis Entregas Asignadas</h2>
            <div class="order-list-container" id="deliveryOrdersContainer"></div>
        </section>
    </main>

    <!-- Modal del Carrito -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Tu Carrito</h3><button class="close-modal">&times;</button></div>
            <div class="modal-body">
                <div id="cartItemsContainer"></div>
                <div class="payment-methods">
                    <div class="form-group">
                        <label for="paymentMethodSelect">Método de Pago</label>
                        <select id="paymentMethodSelect">
                            <option value="">Seleccione una opción...</option>
                            <option value="Efectivo Bs">Efectivo Bs</option>
                            <option value="Efectivo $">Efectivo $</option>
                            <option value="Efectivo €">Efectivo €</option>
                            <option value="Pago Móvil">Pago Móvil</option>
                            <option value="Punto de Venta">Punto de Venta</option>
                        </select>
                    </div>
                    <div id="pagoMovilDetails">
                        <!-- El contenido se genera dinámicamente -->
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button id="checkoutBtn" class="btn-primary">Finalizar Compra</button><button id="processOrderBtn" class="btn-primary" style="display:none;">Procesar Pedido</button></div>
        </div>
    </div>
    
    <!-- === MODAL PARA PRODUCTOS (AÑADIR/EDITAR) === -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Añadir Nuevo Producto</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label for="productName">Nombre del Producto</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Categoría</label>
                        <input type="text" id="productCategory" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Precio</label>
                        <input type="number" id="productPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Descripción</label>
                        <textarea id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="productImage">Imagen del Producto</label>
                        <input type="file" id="productImage" accept="image/*">
                        <input type="hidden" id="existingImageUrl">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveProductBtn" class="btn-primary">Guardar Producto</button>
            </div>
        </div>
    </div>

    <!-- === MODAL PARA EDITAR PERFIL === -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="profileModalTitle">Editar Perfil</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileFirstName">Nombre</label>
                            <input type="text" id="profileFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="profileLastName">Apellido</label>
                            <input type="text" id="profileLastName" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="profileAddress">Dirección Completa</label>
                        <textarea id="profileAddress" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">Número de Contacto</label>
                        <input type="tel" id="profilePhone" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveProfileBtn" class="btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <!-- === MODAL PARA TÉRMINOS Y CONDICIONES === -->
    <div class="modal" id="termsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Términos y Condiciones</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" style="line-height: 1.5;">
                <h4 style="margin-bottom: 0.5rem;">1. Uso de Datos</h4>
                <p>Al registrarte, aceptas que Arcanos Lunch recopile y utilice tu nombre, dirección y número de teléfono con el único propósito de gestionar y entregar tus pedidos a domicilio (delivery).</p>
                <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">2. Responsabilidad</h4>
                <p>La información proporcionada debe ser veraz y precisa. El restaurante no se hace responsable por entregas fallidas o demoradas debido a datos incorrectos o incompletos.</p>
                <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">3. Comunicación</h4>
                <p>Aceptas que nuestro personal de delivery pueda contactarte a través del número de teléfono proporcionado para coordinar la entrega de tu pedido.</p>
                <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">4. Seguridad de Datos</h4>
                <p>Nos comprometemos a proteger tu información personal y a no compartirla con terceros no relacionados con el proceso de entrega de tu pedido.</p>
                <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">5. Aceptación</h4>
                <p>Marcar la casilla de aceptación es un requisito indispensable para crear tu cuenta y utilizar nuestros servicios de delivery. Al hacerlo, confirmas que has leído, entendido y aceptado estos términos.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary close-modal">Cerrar</button>
            </div>
        </div>
    </div>


    <!-- Navegación Inferior -->
    <nav class="magic-nav" id="magicNav"></nav>
    
    <!-- Notificación -->
    <div class="notification" id="notification"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAY9aPCtpNEv77Bmm3ITDwuwg7FPSWVHTA",
            authDomain: "arcanosweb-3a746.firebaseapp.com",
            projectId: "arcanosweb-3a746",
            storageBucket: "arcanosweb-3a746.appspot.com",
            messagingSenderId: "708200899753",
            appId: "1:708200899753:web:eafb8bf818a25fdbfd75b8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null, currentUserRole = 'customer', currentCategory = 'all';
        let products = [], allOrders = [], cart = [], cartByTable = {};
        let activeListeners = []; // Array to hold all active listeners
        let chefFilter = 'pending', cashierOrderTypeFilter = 'mesa', waiterFilter = 'active';
        let paymentMethods = []; // Almacenar métodos de pago

        // --- DOM Elements ---
        const mainHeader = document.getElementById('mainHeader');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const magicNav = document.getElementById('magicNav');
        const allSections = document.querySelectorAll('main > section');
        const productsContainer = document.getElementById('productsContainer');
        const waiterOrdersContainer = document.getElementById('waiterOrdersContainer');
        const kitchenOrdersContainer = document.getElementById('kitchenOrdersContainer');
        const cashierOrdersContainer = document.getElementById('cashierOrdersContainer');
        const deliveryOrdersContainer = document.getElementById('deliveryOrdersContainer');
        const notification = document.getElementById('notification');
        
        // New User Setup
        const newUserSetupSection = document.getElementById('newUserSetupSection');
        const newUserSetupForm = document.getElementById('newUserSetupForm');
        const termsModal = document.getElementById('termsModal');
        const openTermsLink = document.getElementById('openTermsLink');

        // Profile Modal
        const profileModal = document.getElementById('profileModal');
        const saveProfileBtn = document.getElementById('saveProfileBtn');

        // Carts & Payment
        const cartModal = document.getElementById('cartModal');
        const desktopCartBtn = document.getElementById('desktopCartBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const processOrderBtn = document.getElementById('processOrderBtn');
        const paymentMethodSelect = document.getElementById('paymentMethodSelect');
        const pagoMovilDetailsDiv = document.getElementById('pagoMovilDetails');

        // Auth
        const authForm = document.getElementById('authForm'), authEmail = document.getElementById('authEmail'), authPassword = document.getElementById('authPassword'), confirmPasswordField = document.getElementById('confirmPasswordField'), authSubmitBtn = document.getElementById('authSubmitBtn'), authMessage = document.getElementById('authMessage'), signUpLink = document.getElementById('signUpLink'), forgotPasswordLink = document.getElementById('forgotPasswordLink'), loginLink = document.getElementById('loginLink'), googleLoginBtn = document.getElementById('googleLogin'), appleLoginBtn = document.getElementById('appleLogin'), linkSeparator = document.getElementById('linkSeparator'), passwordField = document.getElementById('passwordField');
        let authMode = 'login';
        
        // Sidebar
        const sidebar = document.getElementById('sidebar'), overlay = document.getElementById('overlay'), menuToggle = document.getElementById('menuToggle'), closeSidebar = document.getElementById('closeSidebar'), categoriesContainer = document.getElementById('categoriesContainer');

        // Product Modal
        const productModal = document.getElementById('productModal');

        // --- Listener Management ---
        function cleanupListeners() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
        }

        // --- Auth State ---
        auth.onAuthStateChanged(async user => {
            cleanupListeners(); // Clean up any previous listeners
            currentUser = user;
            if (user) {
                const userDocRef = db.collection("customers").doc(user.uid);
                const doc = await userDocRef.get();

                if (doc.exists && (doc.data().address || doc.data().role !== 'customer')) {
                    authSection.style.display = 'none';
                    newUserSetupSection.style.display = 'none';
                    mainHeader.classList.add('visible');
                    magicNav.classList.add('visible');
                    currentUserRole = doc.data().role || 'customer';
                    loadInitialDataForRole();
                    loadProducts();
                } else {
                    if (!doc.exists) {
                        await saveCustomerData(user, 'customer');
                    }
                    allSections.forEach(s => s.style.display = 'none');
                    mainHeader.classList.remove('visible');
                    magicNav.classList.remove('visible');
                    authSection.style.display = 'none';
                    
                    newUserSetupForm.reset();
                    newUserSetupSection.style.display = 'block';
                }
            } else {
                authSection.style.display = 'flex';
                setTimeout(() => authSection.style.opacity = '1', 50);
                mainHeader.classList.remove('visible');
                magicNav.classList.remove('visible');
                allSections.forEach(s => { if(s.id !== 'authSection') s.style.display = 'none'; });
                setAuthMode('login');
            }
        });

        async function saveCustomerData(user, role = 'customer', extraData = {}) {
            const displayName = user.displayName || "Nuevo Usuario";
            let customerData = {
                uid: user.uid,
                email: user.email,
                displayName: displayName,
                role: role,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                ...extraData
            };

            if (role === 'delivery') {
                customerData.deliveryStatus = 'disponible';
                customerData.lastDeliveryTimestamp = firebase.firestore.FieldValue.serverTimestamp();
            }

            return db.collection("customers").doc(user.uid).set(customerData, { merge: true });
        }

        function setAuthMode(mode) {
            authMode = mode;
            authForm.reset();
            const isLogin = mode === 'login';
            const isRegister = mode === 'register';
            const isForgot = mode === 'forgot';

            passwordField.style.display = isForgot ? 'none' : 'block';
            confirmPasswordField.style.display = isRegister ? 'block' : 'none';
            
            signUpLink.style.display = isLogin ? 'inline' : 'none';
            forgotPasswordLink.style.display = isLogin ? 'inline' : 'none';
            linkSeparator.style.display = isLogin ? 'inline' : 'none';
            loginLink.style.display = !isLogin ? 'inline' : 'none';
            
            const authContainer = authForm.closest('.auth-container');
            if (authContainer) {
                authContainer.querySelector('.separator').style.display = isForgot ? 'none' : 'flex';
                authContainer.querySelector('.auth-options').style.display = isForgot ? 'none' : 'grid';
            }

            authMessage.textContent = 
                isLogin ? "Bienvenido de nuevo" : 
                (isRegister ? "Crea tu cuenta" : "Recupera tu acceso");
            
            authSubmitBtn.textContent = 
                isLogin ? "Iniciar Sesión" : 
                (isRegister ? "Registrarse" : "Enviar enlace de recuperación");
        }
        
        // --- UI & Navigation ---
        function showSection(sectionId) {
            allSections.forEach(s => s.style.display = 'none');
            const targetSection = document.getElementById(`${sectionId}Section`);
            if (targetSection) targetSection.style.display = 'block';
            
            document.querySelectorAll('.magic-nav-item').forEach(item => {
                let itemSection = item.dataset.section;
                item.classList.toggle('active', itemSection === sectionId);
            });
        }

        function updateUIForRole() {
            const navConfig = {
                customer: [{i:'fa-store', t:'Menú', s:'menu'}, {i:'fa-receipt', t:'Pedidos', s:'orders'}, {i:'fa-user', t:'Perfil', s:'profile'}],
                waiter: [{i:'fa-concierge-bell', t:'Mesas', s:'waiter'}, {i:'fa-receipt', t:'Pedidos', s:'orders'}],
                chef: [{i:'fa-hat-chef', t:'Cocina', s:'chef'}],
                cashier: [{i:'fa-cash-register', t:'Caja', s:'cashier'}],
                delivery: [{i:'fa-motorcycle', t:'Entregas', s:'delivery'}],
                admin: [{i:'fa-cogs', t:'Admin', s:'admin'}]
            };
            const roleKey = currentUserRole.includes('chef') ? 'chef' : currentUserRole;
            magicNav.innerHTML = (navConfig[roleKey] || []).map(item => 
                `<a href="#" class="magic-nav-item" data-section="${item.s}"><i class="fas ${item.i}"></i><span>${item.t}</span></a>`
            ).join('');
            
            if (['customer', 'waiter'].includes(currentUserRole)) {
                magicNav.innerHTML += `<a href="#" class="magic-nav-item" data-section="cart"><i class="fas fa-shopping-cart"></i><span class="cart-count">0</span></a>`;
            }

            document.querySelectorAll('.magic-nav-item').forEach(item => item.addEventListener('click', e => {
                e.preventDefault();
                const section = item.dataset.section;
                if (section === 'cart') openCartModal();
                else showSection(section);
            }));

            desktopCartBtn.style.display = ['customer', 'waiter'].includes(currentUserRole) ? 'block' : 'none';
            menuToggle.style.display = currentUserRole === 'customer' ? 'block' : 'none';
            logoutBtn.style.display = 'block';
        }

        function loadInitialDataForRole() {
            updateUIForRole();
            const roleToAction = {
                customer: () => { showSection('menu'); listenForCustomerOrders(); renderProfile(); },
                waiter: () => { showSection('waiter'); listenForTableLocks(); listenForWaiterOrders(); renderWaiterProducts(); },
                chef: () => { showSection('chef'); listenForKitchenOrders(); },
                cashier: () => { showSection('cashier'); listenForCashierOrders(); },
                delivery: () => { showSection('delivery'); listenForDeliveryOrders(); },
                admin: () => { showSection('admin'); setupAdminPanel(); }
            };
            const action = roleToAction[currentUserRole] || roleToAction.customer;
            action();
            setupFilterControls();
        }

        // === ADMIN PANEL FUNCTIONS ===
        function setupAdminPanel() {
            const tabs = document.getElementById('adminTabs');
            const contents = document.querySelectorAll('.admin-tab-content');
            
            tabs.addEventListener('click', (e) => {
                if(e.target.tagName !== 'BUTTON') return;

                tabs.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');

                contents.forEach(content => content.classList.remove('active'));
                const targetContent = document.getElementById(`admin-tab-${e.target.dataset.tab}`);
                targetContent.classList.add('active');
                
                const filter = e.target.dataset.filter;
                if (e.target.dataset.tab === 'menu') loadAdminProducts();
                else if (e.target.dataset.tab === 'employees') loadEmployees(filter || 'employees');
                else if (e.target.dataset.tab === 'payment') loadPaymentMethods();
            });

            document.getElementById('employeeFilterControls').addEventListener('click', (e) => {
                if(e.target.tagName !== 'BUTTON') return;
                document.getElementById('employeeFilterControls').querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                loadEmployees(e.target.dataset.filter);
            });

            document.getElementById('addNewProductBtn').addEventListener('click', () => openProductModal());
            document.getElementById('saveProductBtn').addEventListener('click', handleProductFormSubmit);
            document.getElementById('paymentMethodForm').addEventListener('submit', handleSavePaymentMethod);
            document.getElementById('cancelEditPaymentBtn').addEventListener('click', () => openPaymentMethodForm()); // Resets form
            
            loadAdminProducts();
        }
        
        // --- Payment Methods CRUD (Admin) ---
        async function loadPaymentMethods() { /* ... No changes ... */ }
        function openPaymentMethodForm(method = null) { /* ... No changes ... */ }
        async function handleSavePaymentMethod(e) { /* ... No changes ... */ }
        async function handleDeletePaymentMethod(id) { /* ... No changes ... */ }

        // --- Product CRUD Functions (Admin) ---
        async function loadAdminProducts() { /* ... No changes ... */ }
        async function openProductModal(productId = null) { /* ... No changes ... */ }
        async function handleProductFormSubmit() { /* ... No changes ... */ }
        async function handleDeleteProduct(productId, imageUrl) { /* ... No changes ... */ }
        
        // --- Employee CRUD Functions (Admin) ---
        async function loadEmployees(filter = 'employees') {
            const container = document.getElementById('employeeList');
            const statusDiv = document.getElementById('employeeListStatus');
            container.innerHTML = '';
            statusDiv.innerHTML = '<p>Cargando...</p>';

            const employeeRoles = ['waiter', 'chef', 'cashier', 'admin', 'delivery'];
            let query;
            if (filter === 'employees') query = db.collection('customers').where('role', 'in', employeeRoles);
            else query = db.collection('customers').where('role', '==', 'customer');

            try {
                const snapshot = await query.get();
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (users.length === 0) {
                    statusDiv.innerHTML = `<p class="empty-list-message">No se encontraron ${filter}.</p>`;
                    return;
                }
                
                statusDiv.innerHTML = '';
                container.innerHTML = users.map(user => {
                    const isDelivery = user.role === 'delivery';
                    const deliveryStatusHTML = isDelivery ? `
                        <select class="delivery-status-select">
                            <option value="disponible" ${user.deliveryStatus === 'disponible' ? 'selected' : ''}>Disponible</option>
                            <option value="en_entrega" ${user.deliveryStatus === 'en_entrega' ? 'selected' : ''}>En Entrega</option>
                        </select>
                    ` : '';

                    return `
                    <div class="employee-item" data-id="${user.id}" style="grid-template-columns: 1fr auto ${isDelivery ? 'auto' : ''} auto;">
                        <div class="employee-info">
                            <p><strong>${user.displayName || 'Sin Nombre'}</strong></p>
                            <p class="email">${user.email}</p>
                        </div>
                        <select class="role-select">
                            <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>Cliente</option>
                            <option value="waiter" ${user.role === 'waiter' ? 'selected' : ''}>Mesero</option>
                            <option value="chef" ${user.role.includes('chef') ? 'selected' : ''}>Cocinero</option>
                            <option value="cashier" ${user.role === 'cashier' ? 'selected' : ''}>Cajero</option>
                            <option value="delivery" ${isDelivery ? 'selected' : ''}>Repartidor</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        ${deliveryStatusHTML}
                        <button class="btn-secondary save-role-btn">Guardar</button>
                    </div>
                `}).join('');

                container.querySelectorAll('.save-role-btn').forEach(btn => btn.addEventListener('click', handleRoleUpdate));
            } catch (error) {
                console.error("Error loading users: ", error);
                statusDiv.innerHTML = `<p class="empty-list-message" style="color: var(--danger);">Error al cargar: ${error.message}</p>`;
            }
        }

        async function handleRoleUpdate(e) {
            const item = e.target.closest('.employee-item');
            const userId = item.dataset.id;
            const newRole = item.querySelector('.role-select').value;
            const deliveryStatusSelect = item.querySelector('.delivery-status-select');
            
            e.target.disabled = true;
            e.target.textContent = '...';

            try {
                let updateData = { role: newRole };
                if (newRole === 'delivery') {
                    updateData.deliveryStatus = deliveryStatusSelect ? deliveryStatusSelect.value : 'disponible';
                    // Set timestamp if becoming available
                    if (updateData.deliveryStatus === 'disponible') {
                        updateData.lastDeliveryTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                    }
                } else {
                    // Remove delivery-specific fields if role changes
                    updateData.deliveryStatus = firebase.firestore.FieldValue.delete();
                    updateData.lastDeliveryTimestamp = firebase.firestore.FieldValue.delete();
                }

                await db.collection('customers').doc(userId).update(updateData);
                showNotification('Rol actualizado con éxito.');
                
                loadEmployees(document.querySelector('#employeeFilterControls .filter-btn.active').dataset.filter);

            } catch (error) {
                console.error("Error updating role: ", error);
                showNotification('Error al actualizar el rol.', 'error');
            } finally {
                e.target.disabled = false;
                e.target.textContent = 'Guardar';
            }
        }

        // --- Product & Category Functions (Customer/Waiter) ---
        function loadProducts() { /* ... No changes ... */ }
        function renderCategoryFilters() { /* ... No changes ... */ }
        function filterProductsByCategory(category) { /* ... No changes ... */ }
        function renderProducts() { /* ... No changes ... */ }
        function createProductCard(p) { /* ... No changes ... */ }

        // --- Order & Notification Functions ---
        async function assignDeliveryOrder(orderId) {
            const availableDriversQuery = db.collection('customers')
                .where('role', '==', 'delivery')
                .where('deliveryStatus', '==', 'disponible')
                .orderBy('lastDeliveryTimestamp', 'asc')
                .limit(1);

            const snapshot = await availableDriversQuery.get();

            if (snapshot.empty) {
                showNotification("No hay repartidores disponibles. El pedido quedará en espera.", "warning");
                return;
            }

            const driverDoc = snapshot.docs[0];
            const driverId = driverDoc.id;

            const orderRef = db.collection('orders').doc(orderId);
            const driverRef = db.collection('customers').doc(driverId);

            const batch = db.batch();
            batch.update(orderRef, { status: 'assigned', driverId: driverId, driverName: driverDoc.data().displayName });
            batch.update(driverRef, { deliveryStatus: 'en_entrega' });
            
            await batch.commit();
            showNotification(`Pedido asignado a ${driverDoc.data().displayName}.`);
        }

        function listenForCustomerOrders() {
            const query = db.collection("orders").where('userId', "==", currentUser.uid).orderBy('date', 'desc');
            const unsubscribe = query.onSnapshot(snapshot => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFilteredOrders(waiterOrdersContainer, 'all'); // Re-using waiter container for customer
            }, console.error);
            activeListeners.push(unsubscribe);
        }
        function listenForWaiterOrders() {
            const query = db.collection("orders").where('waiterId', "==", currentUser.uid);
            const unsubscribe = query.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "modified") {
                        const newData = change.doc.data();
                        if (newData.status === 'ready') showNotification(`¡El pedido de la Mesa ${newData.table} está listo!`);
                    }
                });
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                renderFilteredOrders(waiterOrdersContainer, waiterFilter);
            }, console.error);
            activeListeners.push(unsubscribe);
        }
        function listenForKitchenOrders() {
            const query = db.collection("orders");
            const unsubscribe = query.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added" && change.doc.data().status === 'pending') {
                        const order = change.doc.data();
                        showNotification(`Nuevo pedido para ${order.table ? `la Mesa ${order.table}` : 'delivery'}`);
                    }
                });
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => new Date(a.date) - new Date(b.date));
                renderFilteredOrders(kitchenOrdersContainer, chefFilter);
            }, console.error);
            activeListeners.push(unsubscribe);
        }
        function listenForCashierOrders() {
            const query = db.collection("orders");
            const unsubscribe = query.onSnapshot(snapshot => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => new Date(b.date) - new Date(a.date));
                renderFilteredOrders(cashierOrdersContainer, cashierOrderTypeFilter);
            }, console.error);
            activeListeners.push(unsubscribe);
        }
        function listenForDeliveryOrders() {
            const query = db.collection("orders")
                .where("driverId", "==", currentUser.uid)
                .where("status", "in", ["assigned", "en_camino"]);

            const unsubscribe = query.onSnapshot(snapshot => {
                const deliveryOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders(deliveryOrdersContainer, deliveryOrders);
            }, console.error);
            activeListeners.push(unsubscribe);
        }

        function renderFilteredOrders(container, filter) {
            if (!container) return;
            let filtered = [];

            if (currentUserRole === 'cashier') {
                const targetStatuses = filter === 'mesa' ? ['ready'] : ['ready', 'assigned', 'en_camino', 'delivered_pending_cashier'];
                filtered = allOrders.filter(order => order.type === filter && targetStatuses.includes(order.status));
            } else { 
                const statusMap = { all: ['pending', 'preparing', 'ready', 'assigned', 'en_camino', 'delivered_pending_cashier', 'paid', 'cancelled'], active: ['pending', 'preparing', 'ready'], history: ['paid', 'cancelled'] };
                const targetStatuses = statusMap[filter] || [filter];
                filtered = allOrders.filter(order => targetStatuses.includes(order.status));
            }
            
            renderOrders(container, filtered);
        }

        function renderOrders(container, orders) {
             if (!container) return;
             container.innerHTML = orders.length === 0 ? '<p class="empty-list-message">No hay pedidos.</p>' : orders.map(createOrderCard).join('');
             setupCardActions(container);
        }

        function createOrderCard(order) {
            let actions = '';
            
            if (currentUserRole === 'customer' && order.type === 'delivery') {
                return createCustomerOrderTrackerCard(order);
            }

            // CHEF ACTIONS
            if (currentUserRole.includes('chef')) {
                if (order.status === 'pending') actions = `<button class="btn-primary" data-action="prepare" data-id="${order.id}">Preparar</button>`;
                if (order.status === 'preparing') actions = `<button class="btn-primary" style="background-color: var(--success);" data-action="ready" data-id="${order.id}" data-type="${order.type}">Listo</button>`;
            } 
            // DELIVERY ACTIONS
            else if (currentUserRole === 'delivery') {
                if (order.status === 'assigned') actions = `<button class="btn-primary" data-action="start_delivery" data-id="${order.id}">Iniciar Entrega</button>`;
                if (order.status === 'en_camino') actions = `<button class="btn-primary" style="background-color: var(--success);" data-action="complete_delivery" data-id="${order.id}">Entrega Completada</button>`;
            }
            // CASHIER ACTIONS
            else if (currentUserRole === 'cashier') {
                if (order.type === 'mesa' && order.status === 'ready') {
                    actions = `<button class="btn-primary" data-action="pay" data-id="${order.id}">Marcar Pagado</button>`;
                } else if (order.type === 'delivery' && order.status === 'delivered_pending_cashier') {
                    actions = `<button class="btn-primary" style="background-color: var(--success);" data-action="pay" data-id="${order.id}">Confirmar Pago y Cerrar</button>`;
                }
            }
            return `<div class="order-card status-${order.status}">
                        <div class="order-header">
                            <div><h4>Pedido #${order.id.slice(-6)}</h4><span>${order.table ? `Mesa ${order.table}` : (order.driverName ? `Repartidor: ${order.driverName}` : (order.userName || 'Cliente Delivery'))}</span></div>
                            <span class="item-status status-${order.status}">${getStatusText(order.status)}</span>
                        </div>
                        <div class="order-items">${(order.items || []).map(it => `<div class="order-item"><span>${it.quantity}x</span> <span>${it.name}</span></div>`).join('')}</div>
                        ${actions ? `<div class="order-actions">${actions}</div>` : ''}
                    </div>`;
        }

        function createCustomerOrderTrackerCard(order) {
            const stages = {
                'pending': { step: 1, text: 'Recibido', icon: 'fa-receipt' },
                'preparing': { step: 2, text: 'En Preparación', icon: 'fa-hat-chef' },
                'ready': { step: 3, text: 'Listo para Enviar', icon: 'fa-box-open' },
                'assigned': { step: 3, text: 'Listo para Enviar', icon: 'fa-box-open' },
                'en_camino': { step: 4, text: 'En Camino', icon: 'fa-motorcycle' },
                'delivered_pending_cashier': { step: 5, text: 'Entregado', icon: 'fa-check-double' },
                'paid': { step: 5, text: 'Entregado', icon: 'fa-check-double' }
            };

            const currentStage = stages[order.status] || { step: 0, text: 'Desconocido', icon: 'fa-question' };
            
            const trackerSteps = [
                { id: 1, text: 'Recibido', icon: 'fa-receipt' },
                { id: 2, text: 'Preparando', icon: 'fa-hat-chef' },
                { id: 3, text: 'Listo', icon: 'fa-box-open' },
                { id: 4, text: 'En Camino', icon: 'fa-motorcycle' },
                { id: 5, text: 'Entregado', icon: 'fa-check-double' }
            ];

            const progressPercentage = (currentStage.step - 1) / (trackerSteps.length - 1) * 100;

            return `
                <div class="order-card status-${order.status}">
                    <div class="order-header">
                        <div><h4>Pedido #${order.id.slice(-6)}</h4><span>${new Date(order.date).toLocaleDateString()}</span></div>
                        <span class="item-status status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    <div class="order-tracker">
                        <div class="tracker-progress" style="width: ${progressPercentage}%;"></div>
                        ${trackerSteps.map(step => `
                            <div class="tracker-step ${currentStage.step >= step.id ? 'completed' : ''} ${currentStage.step === step.id ? 'active' : ''}">
                                <div class="icon"><i class="fas ${step.icon}"></i></div>
                                <div class="label">${step.text}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-items">${(order.items || []).map(it => `<div class="order-item"><span>${it.quantity}x</span> <span>${it.name}</span></div>`).join('')}</div>
                </div>
            `;
        }

        function setupCardActions(container) {
            if (!container) return;
            container.addEventListener('click', async e => {
                const target = e.target.closest('button');
                if (!target) return;
                const { action, id, type } = target.dataset;

                if (action === 'prepare') updateOrderStatus(id, 'preparing');
                if (action === 'ready') {
                    await updateOrderStatus(id, 'ready');
                    if (type === 'delivery') {
                        assignDeliveryOrder(id);
                    }
                }
                if (action === 'start_delivery') updateOrderStatus(id, 'en_camino');
                if (action === 'complete_delivery') {
                    await updateOrderStatus(id, 'delivered_pending_cashier');
                    // Make driver available again and put at the end of the queue
                    db.collection('customers').doc(currentUser.uid).update({
                        deliveryStatus: 'disponible',
                        lastDeliveryTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                if (action === 'pay') updateOrderStatus(id, 'paid');
            });
        }
        function updateOrderStatus(orderId, status) {
            return db.collection("orders").doc(orderId).update({ status }).then(() => showNotification("Estado actualizado")).catch(err => showNotification('Error al actualizar', 'error'));
        }

        // --- Cart Functions ---
        function getActiveCart() { /* ... No changes ... */ }
        function addToCart(productId) { /* ... No changes ... */ }
        function updateCartCount() { /* ... No changes ... */ }
        async function openCartModal() { /* ... No changes ... */ }
        function closeCartModal() { /* ... No changes ... */ }
        function renderCart() { /* ... No changes ... */ }
        function renderPagoMovilOptions() { /* ... No changes ... */ }
        
        async function processWaiterOrder() {
            const activeCart = getActiveCart();
            if (!activeCart || activeCart.length === 0 || !currentTable) return showNotification('Seleccione mesa y añada productos.', 'error');
            const order = {
                date: new Date().toISOString(), waiterId: currentUser.uid,
                userName: `Mesa ${currentTable}`, items: activeCart,
                total: activeCart.reduce((s, i) => s + (i.price * i.quantity), 0),
                status: 'pending', table: currentTable, type: 'mesa',
                payment: { method: 'En mesa' }
            };
            try {
                await db.collection("orders").add(order);
                showNotification(`Pedido para Mesa ${currentTable} enviado.`);
                cartByTable[currentTable] = [];
                document.querySelector('.table-card.active')?.classList.remove('active');
                currentTable = null;
                updateCartCount();
                closeCartModal();
            } catch (error) { showNotification('Error al guardar el pedido', 'error'); }
        }
        async function checkout() {
            const paymentMethod = paymentMethodSelect.value;
            const pagoMovilRef = document.getElementById('pagoMovilRef')?.value;
            const pagoMovilAccountSelect = document.getElementById('pagoMovilAccountSelect');

            if (cart.length === 0) return showNotification('El carrito está vacío', 'error');
            if (!paymentMethod) return showNotification('Por favor, seleccione un método de pago.', 'error');
            
            let paymentData = { method: paymentMethod };

            if (paymentMethod === 'Pago Móvil') {
                if (!pagoMovilRef || pagoMovilRef.length < 6) return showNotification('La referencia de Pago Móvil debe tener al menos 6 dígitos.', 'error');
                paymentData.reference = pagoMovilRef;

                if (pagoMovilAccountSelect) { // Multiple accounts
                    if(!pagoMovilAccountSelect.value) return showNotification('Por favor, selecciona la cuenta de Pago Móvil a la que transferiste.', 'error');
                    const selectedAccount = paymentMethods.find(m => m.id === pagoMovilAccountSelect.value);
                    paymentData.destination = `${selectedAccount.bank} - ${selectedAccount.phone}`;
                } else { // Single account
                    const selectedAccount = paymentMethods[0];
                    paymentData.destination = `${selectedAccount.bank} - ${selectedAccount.phone}`;
                }
            }
            
            const order = {
                date: new Date().toISOString(), userId: currentUser.uid,
                userName: currentUser.displayName, items: cart,
                total: cart.reduce((s, i) => s + (i.price * i.quantity), 0),
                status: 'pending', type: 'delivery',
                payment: paymentData
            };

            try {
                await db.collection("orders").add(order);
                showNotification(`Pedido enviado con éxito.`);
                cart = [];
                updateCartCount();
                closeCartModal();
            } catch (error) { showNotification('Error al guardar el pedido', 'error'); }
        }

        // --- Waiter Specific Functions ---
        function listenForTableLocks() { /* ... No changes ... */ }
        function renderWaiterProducts() { /* ... No changes ... */ }

        // --- Profile Functions ---
        async function renderProfile() { /* ... No changes ... */ }
        async function openProfileModal() { /* ... No changes ... */ }
        async function handleProfileUpdate(e) { /* ... No changes ... */ }
        
        function getStatusText(status) {
            const texts = { pending: 'Entrante', preparing: 'En preparación', ready: 'Listo para Asignar', assigned: 'Asignado', en_camino: 'En Camino', delivered_pending_cashier: 'Entregado', paid: 'Pagado', cancelled: 'Cancelado' };
            return texts[status] || status;
        }
        function showNotification(message, type = 'success') { /* ... No changes ... */ }
        function openSidebarFunc() { /* ... No changes ... */ }
        function closeSidebarFunc() { /* ... No changes ... */ }
        
        function setupFilterControls() {
            const configs = [
                { id: 'waiterFilterControls', container: waiterOrdersContainer, filterVar: 'waiterFilter', buttons: [{t:'Activos', s:'active'}, {t:'Historial', s:'history'}] },
                { id: 'chefFilterControls', container: kitchenOrdersContainer, filterVar: 'chefFilter', buttons: [{t:'Entrantes', s:'pending'}, {t:'En Preparación', s:'preparing'}] },
                { id: 'cashierFilterControls', container: cashierOrdersContainer, filterVar: 'cashierOrderTypeFilter', buttons: [{t:'Pedidos en Mesa', s:'mesa'}, {t:'Pedidos en Reparto', s:'delivery'}] },
            ];
            configs.forEach(config => {
                const controls = document.getElementById(config.id);
                if (!controls) return;
                controls.innerHTML = config.buttons.map(b => `<button class="filter-btn ${window[config.filterVar] === b.s ? 'active' : ''}" data-status="${b.s}">${b.t}</button>`).join('');
                controls.addEventListener('click', e => {
                    const target = e.target.closest('.filter-btn');
                    if (!target) return;
                    window[config.filterVar] = target.dataset.status;
                    controls.querySelector('.active')?.classList.remove('active');
                    target.classList.add('active');
                    renderFilteredOrders(config.container, window[config.filterVar]);
                });
            });
        }
        
        // --- NEW USER SETUP ---
        async function handleNewUserSetup(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const btn = document.getElementById('saveUserSetupBtn');
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const userData = {
                displayName: `${document.getElementById('userFirstName').value} ${document.getElementById('userLastName').value}`,
                firstName: document.getElementById('userFirstName').value,
                lastName: document.getElementById('userLastName').value,
                address: document.getElementById('userAddress').value,
                phone: document.getElementById('userPhone').value
            };

            try {
                await saveCustomerData(currentUser, 'customer', userData);
                showNotification('¡Datos guardados con éxito!');
                
                newUserSetupSection.style.display = 'none';
                mainHeader.classList.add('visible');
                magicNav.classList.add('visible');
                
                currentUserRole = 'customer'; 
                loadInitialDataForRole();
                loadProducts();

            } catch (error) {
                console.error("Error saving user data:", error);
                showNotification('Error al guardar tus datos.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Crear Cuenta y Continuar';
            }
        }

        // --- Global Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            newUserSetupForm.addEventListener('submit', handleNewUserSetup);
            saveProfileBtn.addEventListener('click', handleProfileUpdate);
            
            openTermsLink.addEventListener('click', (e) => {
                e.preventDefault();
                termsModal.classList.add('visible');
            });

            [termsModal, profileModal, productModal, cartModal].forEach(modal => {
                modal.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => modal.classList.remove('visible'));
                });
            });

            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = authEmail.value;
                const password = authPassword.value;

                authSubmitBtn.disabled = true;
                authSubmitBtn.textContent = 'Procesando...';

                if (authMode === 'login') {
                    auth.signInWithEmailAndPassword(email, password).catch(handleAuthError);
                } else if (authMode === 'register') {
                    if (password !== authConfirmPassword.value) { 
                        handleAuthError({ message: "Las contraseñas no coinciden." });
                        return; 
                    }
                    auth.createUserWithEmailAndPassword(email, password).catch(handleAuthError);
                } else if (authMode === 'forgot') {
                    auth.sendPasswordResetEmail(email)
                        .then(() => {
                            showNotification("Correo de recuperación enviado. Revisa tu bandeja de entrada.");
                            setAuthMode('login');
                        })
                        .catch(handleAuthError)
                        .finally(() => {
                           authSubmitBtn.disabled = false;
                           authSubmitBtn.textContent = 'Enviar enlace de recuperación';
                        });
                }
            });
            function handleAuthError(error) {
                showNotification(`Error: ${error.message}`, 'error');
                authSubmitBtn.disabled = false;
                setAuthMode(authMode); 
            }
            signUpLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('register'); });
            forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('forgot'); });
            loginLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('login'); });
            googleLoginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(handleAuthError));
            appleLoginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.OAuthProvider('apple.com')).catch(handleAuthError));

            desktopCartBtn.addEventListener('click', openCartModal);
            logoutBtn.addEventListener('click', () => { auth.signOut(); });
            checkoutBtn.addEventListener('click', checkout);
            processOrderBtn.addEventListener('click', processWaiterOrder);
            menuToggle.addEventListener('click', openSidebarFunc);
            closeSidebar.addEventListener('click', closeSidebarFunc);
            overlay.addEventListener('click', closeSidebarFunc);

            paymentMethodSelect.addEventListener('change', (e) => {
                pagoMovilDetailsDiv.style.display = e.target.value === 'Pago Móvil' ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
