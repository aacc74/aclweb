<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcanos Lunch | Futuro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Paleta de Colores "Futuro Cálido" */
            --primary: #F97316; /* Naranja Neón */
            --primary-glow: rgba(249, 115, 22, 0.4);
            --primary-dark: #EA580C;
            
            --dark-bg: #111827;      /* Fondo principal (Gris-Azul oscuro) */
            --dark-card: #1F2937;    /* Fondo de tarjetas */
            --dark-border: #374151;  /* Bordes y divisores */
            
            --light-text: #F9FAFB;   /* Texto principal */
            --gray-text: #9CA3AF;    /* Texto secundario */

            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;

            /* Tipografía */
            --font-sans: 'Inter', sans-serif;
            --font-display: 'Lexend', sans-serif;

            /* Sombras y Efectos */
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --neon-shadow: 0 0 15px var(--primary-glow);
            
            /* Otros */
            --border-radius: 0.75rem; /* 12px */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-sans);
            background-color: var(--dark-bg);
            color: var(--light-text);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: 80px;
            padding-bottom: 80px;
        }
        
        .container {
            width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 1rem;
        }

        h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 700; color: var(--light-text); }
        .section-title { font-size: 1.75rem; margin-bottom: 2rem; text-align: center; }

        /* --- LOGIN FUTURISTA --- */
        #authSection {
            display: flex; justify-content: center; align-items: center;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; padding: 1rem;
            background-color: var(--dark-bg);
            z-index: 2000; transition: opacity 0.3s ease-in-out;
        }
        .auth-container {
            width: 100%; max-width: 420px;
            background: rgba(31, 41, 55, 0.8); /* Glassmorphism */
            backdrop-filter: blur(10px);
            border: 1px solid var(--dark-border);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeInScale 0.5s var(--transition) forwards;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .auth-header { text-align: center; padding: 2.5rem 2rem 1.5rem; }
        .auth-logo i { font-size: 3rem; color: var(--primary); text-shadow: var(--neon-shadow); }
        .auth-logo h2 { font-size: 1.75rem; }
        #authMessage { font-size: 1rem; color: var(--gray-text); margin-top: 0.5rem; }
        .auth-body { padding: 0 2rem 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; color: var(--light-text); }
        .form-group input {
            width: 100%; padding: 0.75rem 1rem;
            background-color: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: var(--border-radius);
            font-size: 1rem; transition: var(--transition); color: var(--light-text);
        }
        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
            outline: none;
        }
        .btn-primary {
            width: 100%; background-color: var(--primary); color: white; border: none;
            padding: 0.875rem; border-radius: var(--border-radius);
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--neon-shadow);
        }
        .btn-primary:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 0 25px var(--primary-glow); }
        .auth-footer { padding: 0 2rem 2rem; text-align: center; }
        .auth-links a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .auth-links a:hover { text-decoration: underline; }
        .separator {
            display: flex; align-items: center; text-align: center;
            color: var(--gray-text); font-size: 0.875rem; margin: 1.5rem 0;
        }
        .separator::before, .separator::after { content: ''; flex: 1; border-bottom: 1px solid var(--dark-border); }
        .separator:not(:empty)::before { margin-right: .5em; }
        .separator:not(:empty)::after { margin-left: .5em; }
        .auth-btn {
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
            padding: 0.75rem; border-radius: var(--border-radius); border: 1px solid var(--dark-border);
            font-weight: 600; cursor: pointer; transition: var(--transition);
            background-color: transparent; color: var(--light-text);
        }
        .auth-btn:hover { background-color: rgba(255,255,255,0.05); border-color: var(--gray-text); }

        /* --- HEADER & NAV --- */
        #mainHeader {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--dark-border);
            padding: 1rem 0; z-index: 900;
            transform: translateY(-100%); transition: transform 0.3s ease-out;
        }
        #mainHeader.visible { transform: translateY(0); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .menu-toggle { background: none; border: none; font-size: 1.25rem; color: var(--light-text); cursor: pointer; transition: var(--transition); }
        .menu-toggle:hover { color: var(--primary); }
        .logo { font-family: var(--font-display); font-size: 1.5rem; color: var(--light-text); text-decoration: none; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .cart-btn {
            position: relative; background: none; border: none; font-size: 1.25rem;
            color: var(--light-text); cursor: pointer;
        }
        .cart-count {
            position: absolute; top: -5px; right: -8px;
            background-color: var(--primary); color: white;
            border-radius: 50%; width: 18px; height: 18px;
            font-size: 0.7rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--neon-shadow);
        }
        .logout-btn {
            background: var(--dark-card); color: var(--light-text);
            border: 1px solid var(--dark-border); padding: 0.5rem 1rem; border-radius: var(--border-radius);
            font-weight: 600; cursor: pointer; transition: var(--transition);
        }
        .logout-btn:hover { background: var(--primary); border-color: var(--primary); color: white; }

        #magicNav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px);
            border-top: 1px solid var(--dark-border);
            display: flex; justify-content: space-around;
            padding: 0.5rem 0; z-index: 1000;
            transform: translateY(100%); transition: transform 0.3s ease-out;
        }
        #magicNav.visible { transform: translateY(0); }
        .magic-nav-item {
            display: flex; flex-direction: column; align-items: center;
            text-decoration: none; color: var(--gray-text);
            font-size: 0.75rem; font-weight: 500;
            padding: 0.5rem; border-radius: var(--border-radius);
            transition: var(--transition); width: 64px; position: relative;
        }
        .magic-nav-item.active { color: var(--primary); }
        .magic-nav-item.active i { text-shadow: var(--neon-shadow); }
        .magic-nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .magic-nav-item .cart-count { top: -2px; right: 12px; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: 0; left: 0; width: 280px;
            height: 100%;
            background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(10px);
            border-right: 1px solid var(--dark-border);
            z-index: 1100; transform: translateX(-100%);
            transition: transform 0.4s var(--transition);
            display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { padding: 1.25rem; border-bottom: 1px solid var(--dark-border); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { font-size: 1.2rem; }
        .close-sidebar { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-text); }
        .categories-container { padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .category-btn {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; border-radius: var(--border-radius);
            text-decoration: none; color: var(--gray-text); font-weight: 500;
            transition: var(--transition); border: 1px solid transparent;
        }
        .category-btn:hover { color: var(--light-text); background-color: rgba(255,255,255,0.05); }
        .category-btn.active { background-color: var(--primary); color: white; box-shadow: var(--neon-shadow); }
        .category-btn i { width: 20px; text-align: center; }
        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1050;
            transition: opacity 0.3s; opacity: 0;
        }
        .overlay.active { display: block; opacity: 1; }

        /* --- PRODUCT CARD --- */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .product-card {
            background: var(--dark-card); border-radius: var(--border-radius);
            border: 1px solid var(--dark-border);
            overflow: hidden; transition: var(--transition);
        }
        .product-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--neon-shadow); }
        .product-image { height: 180px; background: var(--dark-bg); }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 1rem; }
        .product-category { font-size: 0.75rem; font-weight: 600; color: var(--primary); margin-bottom: 0.5rem; text-transform: uppercase; }
        .product-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .product-description { color: var(--gray-text); font-size: 0.875rem; margin-bottom: 1rem; min-height: 40px; }
        .product-footer { display: flex; justify-content: space-between; align-items: center; }
        .product-price { font-size: 1.25rem; font-weight: 700; color: var(--light-text); }
        .add-to-cart {
            background-color: var(--primary); color: white; border: none; 
            padding: 0.6rem 1.2rem; border-radius: var(--border-radius);
            cursor: pointer; font-weight: 600; transition: var(--transition);
        }
        .add-to-cart:hover { transform: scale(1.05); box-shadow: var(--neon-shadow); }

        /* --- ORDER VIEWS --- */
        .order-filter-controls { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; justify-content: center; flex-wrap: wrap; }
        .filter-btn {
            padding: 0.5rem 1rem; background: var(--dark-card);
            border: 1px solid var(--dark-border); border-radius: 2rem;
            cursor: pointer; transition: var(--transition); font-weight: 500; color: var(--gray-text);
        }
        .filter-btn.active, .filter-btn:hover { background: var(--primary); color: white; border-color: var(--primary); box-shadow: var(--neon-shadow); }
        .order-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .empty-list-message { color: var(--gray-text); text-align: center; padding: 2rem 0; font-style: italic; grid-column: 1 / -1; }
        .order-card {
            background: var(--dark-card); border-radius: var(--border-radius);
            border: 1px solid var(--dark-border); padding: 1rem; border-left: 4px solid;
        }
        /* ... (resto de estilos de order-card y status) ... */
        
        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.5); z-index: 1500;
            justify-content: center; align-items: center;
        }
        .modal.visible { display: flex; }
        .modal-content {
            background: rgba(31, 41, 55, 0.9); backdrop-filter: blur(10px);
            border: 1px solid var(--dark-border);
            border-radius: var(--border-radius);
            width: 90%; max-width: 500px; max-height: 90vh;
            display: flex; flex-direction: column; box-shadow: var(--shadow-lg);
        }
        /* ... (resto de estilos de modal) ... */

        /* --- WAITER TABLE VIEW --- */
        .table-card {
            background: var(--dark-card); border-radius: var(--border-radius);
            padding: 1rem; text-align: center; cursor: pointer;
            transition: var(--transition); border: 1px solid var(--dark-border);
        }
        .table-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .table-card.active { border-color: var(--primary); background: var(--primary); color: white; box-shadow: var(--neon-shadow); }
        .table-card.locked { background: var(--dark-bg); color: var(--gray-text); cursor: not-allowed; opacity: 0.6; }
        .table-card.active i, .table-card.active span { color: white; }

        /* --- PROFILE CARD --- */
        .profile-card {
            max-width: 500px; margin: 2rem auto; background: var(--dark-card);
            padding: 2rem; border-radius: var(--border-radius); border: 1px solid var(--dark-border);
        }
        .profile-avatar { background: var(--primary); box-shadow: var(--neon-shadow); }
        .detail-item { border-bottom: 1px solid var(--dark-border); }

        /* Notification */
        .notification {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background-color: var(--primary); color: white;
            padding: 0.75rem 1.5rem; border-radius: 2rem;
            box-shadow: var(--neon-shadow); z-index: 2000;
            opacity: 0; transition: opacity 0.3s, transform 0.3s;
        }
        /* (El resto del CSS se mantiene similar, pero adaptado a la paleta oscura) */
        .order-card.status-pending { border-color: var(--warning); } .order-card.status-preparing { border-color: #3B82F6; } .order-card.status-ready { border-color: var(--success); } .order-card.status-paid { border-color: #A78BFA; } .order-card.status-cancelled { border-color: var(--gray-text); }
        .item-status { padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-pending { background-color: var(--warning); } .status-preparing { background-color: #3B82F6; } .status-ready { background-color: var(--success); } .status-paid { background-color: #A78BFA; } .status-cancelled { background-color: var(--gray-text); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; } .order-header h4 { font-size: 1.125rem; } .order-header span { font-size: 0.875rem; color: var(--gray-text); }
        .order-items { border-top: 1px solid var(--dark-border); padding-top: 0.75rem; } .order-item { display: flex; justify-content: space-between; font-size: 0.875rem; padding: 0.25rem 0; } .order-item span:first-child { color: var(--gray-text); } .order-actions { margin-top: 1rem; text-align: right; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--dark-border); display: flex; justify-content: space-between; align-items: center; } .modal-header h3 { font-size: 1.25rem; } .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; } .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--dark-border); text-align: right; } .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-text); }
        .table-selection { margin-bottom: 2rem; } .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; } .table-card i { font-size: 1.75rem; margin-bottom: 0.5rem; color: var(--primary); transition: var(--transition); } .table-card.locked i { color: var(--gray-text); } .table-card span { font-weight: 600; }
        .profile-header { text-align: center; margin-bottom: 1.5rem; } .profile-header h3 { font-size: 1.5rem; } .profile-header p { color: var(--gray-text); } .profile-details { display: flex; flex-direction: column; gap: 1rem; } .detail-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--dark-border); } .detail-item:last-child { border-bottom: none; } .detail-item span:first-child { font-weight: 500; color: var(--light-text); } .detail-item span:last-child { color: var(--gray-text); }
        .notification.show { opacity: 1; transform: translate(-50%, -10px); }
    </style>
</head>
<body>
    <!-- El HTML es idéntico al de la versión anterior -->
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <!-- Header Fijo -->
    <header id="mainHeader">
        <div class="container header-content">
            <div class="header-left">
                <button id="menuToggle" class="menu-toggle" style="display: none;"><i class="fas fa-bars"></i></button>
                <a href="#" class="logo">Arcanos</a>
            </div>
            <div class="header-actions">
                <button id="desktopCartBtn" class="cart-btn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </button>
                <button id="logoutBtn" class="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar de Categorías -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Categorías</h3>
            <button class="close-sidebar" id="closeSidebar"><i class="fas fa-times"></i></button>
        </div>
        <div class="categories-container" id="categoriesContainer"></div>
    </aside>
    <div class="overlay" id="overlay"></div>
    
    <!-- Contenido Principal -->
    <main class="container">
        <!-- Login (se superpone a todo) -->
        <section id="authSection" style="display: none;">
            <div class="auth-container">
                <div class="auth-header">
                    <div class="auth-logo"><i class="fas fa-drumstick-bite"></i><h2>Arcanos Lunch</h2></div>
                    <p id="authMessage">Bienvenido de nuevo</p>
                </div>
                <div class="auth-body">
                    <form id="authForm" class="auth-form">
                        <div class="form-group"><label for="authEmail">Correo</label><input type="email" id="authEmail" required></div>
                        <div class="form-group"><label for="authPassword">Contraseña</label><input type="password" id="authPassword" required></div>
                        <div id="confirmPasswordField" style="display: none;" class="form-group"><label for="authConfirmPassword">Confirmar Contraseña</label><input type="password" id="authConfirmPassword"></div>
                        <button type="submit" class="btn-primary" id="authSubmitBtn">Iniciar Sesión</button>
                    </form>
                </div>
                <div class="auth-footer">
                    <div class="auth-links">
                        <a href="#" id="signUpLink">Crear cuenta</a><span id="linkSeparator" style="margin:0 .5rem">·</span><a href="#" id="forgotPasswordLink">Olvidé contraseña</a><a href="#" id="loginLink" style="display:none">Volver a login</a>
                    </div>
                    <div class="separator">o</div>
                    <div class="auth-options">
                        <button class="auth-btn" id="googleLogin"><i class="fab fa-google"></i><span>Google</span></button>
                        <button class="auth-btn" id="appleLogin"><i class="fab fa-apple"></i><span>Apple</span></button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Secciones de la App -->
        <section id="menuSection" style="display: none;"><h2 class="section-title">Nuestro Menú</h2><div class="products-grid" id="productsContainer"></div></section>
        <section id="ordersSection" style="display: none;"><h2 class="section-title">Mis Pedidos</h2><div class="order-filter-controls" id="waiterFilterControls"></div><div class="order-list-container" id="waiterOrdersContainer"></div></section>
        <section id="profileSection" style="display: none;"><h2 class="section-title">Mi Perfil</h2><div id="profileContainer"></div></section>
        <section id="adminSection" style="display: none;"><h2 class="section-title">Admin</h2></section>
        <section id="waiterSection" style="display: none;"><div class="table-selection" id="tableSelection"></div><h2 class="section-title" id="waiterMenuTitle" style="display:none;"></h2><div class="products-grid" id="waiterProductsContainer"></div></section>
        <section id="chefSection" style="display: none;"><h2 class="section-title">Panel de Cocina</h2><div class="order-filter-controls" id="chefFilterControls"></div><div class="order-list-container" id="kitchenOrdersContainer"></div></section>
        <section id="cashierSection" style="display: none;"><h2 class="section-title">Panel de Caja</h2><div class="order-filter-controls" id="cashierFilterControls"></div><div class="order-list-container" id="cashierOrdersContainer"></div></section>
    </main>

    <!-- Modal del Carrito -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Tu Carrito</h3><button class="close-modal">&times;</button></div>
            <div class="modal-body" id="cartItemsContainer"></div>
            <div class="modal-footer"><button id="checkoutBtn" class="btn-primary">Finalizar Compra</button><button id="processOrderBtn" class="btn-primary" style="display:none;">Procesar Pedido</button></div>
        </div>
    </div>
    
    <!-- Navegación Inferior -->
    <nav class="magic-nav" id="magicNav"></nav>
    
    <!-- Notificación -->
    <div class="notification" id="notification"></div>

    <script>
        // El JavaScript es idéntico al de la versión anterior.
        // No se necesita ningún cambio en la lógica, solo en el CSS.
        // --- CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAY9aPCtpNEv77Bmm3ITDwuwg7FPSWVHTA",
            authDomain: "arcanosweb-3a746.firebaseapp.com",
            projectId: "arcanosweb-3a746",
            storageBucket: "arcanosweb-3a746.appspot.com",
            messagingSenderId: "708200899753",
            appId: "1:708200899753:web:eafb8bf818a25fdbfd75b8"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL STATE ---
        let currentUser = null, currentUserRole = 'customer', currentCategory = 'all';
        let products = [], allOrders = [], cart = [], cartByTable = {};
        let currentTable = null, realtimeOrdersListener = null;
        let chefFilter = 'pending', cashierFilter = 'ready', waiterFilter = 'active';

        // --- DOM REFERENCES ---
        const mainHeader = document.getElementById('mainHeader');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const magicNav = document.getElementById('magicNav');
        const allSections = document.querySelectorAll('main > section');
        const productsContainer = document.getElementById('productsContainer');
        const waiterOrdersContainer = document.getElementById('waiterOrdersContainer');
        const kitchenOrdersContainer = document.getElementById('kitchenOrdersContainer');
        const cashierOrdersContainer = document.getElementById('cashierOrdersContainer');
        const notification = document.getElementById('notification');
        const cartModal = document.getElementById('cartModal');
        const desktopCartBtn = document.getElementById('desktopCartBtn');
        const authForm = document.getElementById('authForm'), authEmail = document.getElementById('authEmail'), authPassword = document.getElementById('authPassword'), authConfirmPassword = document.getElementById('authConfirmPassword'), confirmPasswordField = document.getElementById('confirmPasswordField'), authSubmitBtn = document.getElementById('authSubmitBtn'), authMessage = document.getElementById('authMessage'), signUpLink = document.getElementById('signUpLink'), forgotPasswordLink = document.getElementById('forgotPasswordLink'), loginLink = document.getElementById('loginLink'), googleLoginBtn = document.getElementById('googleLogin'), appleLoginBtn = document.getElementById('appleLogin'), linkSeparator = document.getElementById('linkSeparator');
        let authMode = 'login';
        const checkoutBtn = document.getElementById('checkoutBtn');
        const processOrderBtn = document.getElementById('processOrderBtn');
        const sidebar = document.getElementById('sidebar'), overlay = document.getElementById('overlay'), menuToggle = document.getElementById('menuToggle'), closeSidebar = document.getElementById('closeSidebar'), categoriesContainer = document.getElementById('categoriesContainer');

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                authSection.style.opacity = '0';
                setTimeout(() => authSection.style.display = 'none', 300);
                mainHeader.classList.add('visible');
                magicNav.classList.add('visible');
                
                db.collection("customers").doc(user.uid).get().then(doc => {
                    currentUserRole = doc.exists ? (doc.data().role || 'customer') : 'customer';
                    if (!doc.exists) saveCustomerData(user);
                    loadInitialDataForRole();
                });
                loadProducts();
            } else {
                authSection.style.display = 'flex';
                setTimeout(() => authSection.style.opacity = '1', 50);
                mainHeader.classList.remove('visible');
                magicNav.classList.remove('visible');
                allSections.forEach(s => { if(s.id !== 'authSection') s.style.display = 'none'; });
                if (realtimeOrdersListener) realtimeOrdersListener();
                setAuthMode('login');
            }
        });

        function saveCustomerData(user) {
            db.collection("customers").doc(user.uid).set({
                uid: user.uid, email: user.email,
                displayName: user.displayName || "Cliente",
                role: 'customer',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        function setAuthMode(mode) {
            authMode = mode;
            authForm.reset();
            const isLogin = mode === 'login', isRegister = mode === 'register';
            confirmPasswordField.style.display = isRegister ? 'block' : 'none';
            signUpLink.style.display = isLogin ? 'inline' : 'none';
            forgotPasswordLink.style.display = isLogin ? 'inline' : 'none';
            linkSeparator.style.display = isLogin ? 'inline' : 'none';
            loginLink.style.display = !isLogin ? 'inline' : 'none';
            authMessage.textContent = isLogin ? "Bienvenido de nuevo" : (isRegister ? "Crea tu cuenta" : "Recupera tu acceso");
            authSubmitBtn.textContent = isLogin ? "Iniciar Sesión" : (isRegister ? "Registrarse" : "Enviar enlace");
        }
        
        // --- UI & NAVIGATION ---
        function showSection(sectionId) {
            allSections.forEach(s => s.style.display = 'none');
            const targetSection = document.getElementById(`${sectionId}Section`);
            if (targetSection) targetSection.style.display = 'block';
            
            document.querySelectorAll('.magic-nav-item').forEach(item => {
                let itemSection = item.dataset.section;
                if (currentUserRole === 'waiter' && itemSection === 'menu') itemSection = 'waiter';
                if (currentUserRole.includes('chef')) itemSection = 'chef';
                item.classList.toggle('active', itemSection === sectionId);
            });
        }

        function updateUIForRole() {
            const navConfig = {
                customer: [{i:'fa-store', t:'Menú', s:'menu'}, {i:'fa-receipt', t:'Pedidos', s:'orders'}, {i:'fa-user', t:'Perfil', s:'profile'}],
                waiter: [{i:'fa-concierge-bell', t:'Mesas', s:'waiter'}, {i:'fa-receipt', t:'Pedidos', s:'orders'}],
                chef: [{i:'fa-hat-chef', t:'Cocina', s:'chef'}],
                cashier: [{i:'fa-cash-register', t:'Caja', s:'cashier'}],
                admin: [{i:'fa-cogs', t:'Admin', s:'admin'}]
            };
            const roleKey = currentUserRole.includes('chef') ? 'chef' : currentUserRole;
            magicNav.innerHTML = (navConfig[roleKey] || []).map(item => 
                `<a href="#" class="magic-nav-item" data-section="${item.s}"><i class="fas ${item.i}"></i><span>${item.t}</span></a>`
            ).join('');
            
            if (['customer', 'waiter'].includes(currentUserRole)) {
                magicNav.innerHTML += `<a href="#" class="magic-nav-item" data-section="cart"><i class="fas fa-shopping-cart"></i><span class="cart-count">0</span></a>`;
            }

            document.querySelectorAll('.magic-nav-item').forEach(item => item.addEventListener('click', e => {
                e.preventDefault();
                const section = item.dataset.section;
                if (section === 'cart') openCartModal();
                else showSection(section);
            }));

            desktopCartBtn.style.display = ['customer', 'waiter'].includes(currentUserRole) ? 'block' : 'none';
            menuToggle.style.display = currentUserRole === 'customer' ? 'block' : 'none';
            logoutBtn.style.display = 'block';
        }

        function loadInitialDataForRole() {
            updateUIForRole();
            if (realtimeOrdersListener) realtimeOrdersListener();
            const roleToAction = {
                waiter: () => { showSection('waiter'); listenForTableLocks(); listenForWaiterOrders(); renderWaiterProducts(); },
                chef: () => { showSection('chef'); listenForKitchenOrders(); },
                cashier: () => { showSection('cashier'); listenForCashierOrders(); },
                admin: () => showSection('admin'),
                customer: () => { showSection('menu'); listenForWaiterOrders(); renderProfile(); }
            };
            const action = roleToAction[currentUserRole.includes('chef') ? 'chef' : currentUserRole] || roleToAction.customer;
            action();
            setupFilterControls();
        }

        // --- PRODUCT & ORDER LOGIC ---
        function loadProducts() {
            db.collection("products").get().then(snapshot => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategoryFilters();
                renderProducts();
                renderWaiterProducts();
            });
        }
        function renderCategoryFilters() {
            const categories = [...new Set(products.map(p => p.category))];
            categoriesContainer.innerHTML = `<a href="#" class="category-btn active" data-category="all"><i class="fas fa-utensils"></i><span>Todos</span></a>` +
                categories.map(cat => `<a href="#" class="category-btn" data-category="${cat}"><i class="fas fa-tag"></i><span>${cat}</span></a>`).join('');
            categoriesContainer.querySelectorAll('.category-btn').forEach(btn => btn.addEventListener('click', (e) => {
                e.preventDefault();
                filterProductsByCategory(btn.dataset.category);
            }));
        }
        function filterProductsByCategory(category) {
            currentCategory = category;
            renderProducts();
            categoriesContainer.querySelector('.active').classList.remove('active');
            categoriesContainer.querySelector(`[data-category="${category}"]`).classList.add('active');
            closeSidebarFunc();
        }
        function renderProducts() {
            if (!productsContainer) return;
            let filtered = (currentCategory === 'all') ? products : products.filter(p => p.category === currentCategory);
            productsContainer.innerHTML = filtered.map(createProductCard).join('');
            productsContainer.querySelectorAll('.add-to-cart').forEach(b => b.addEventListener('click', e => addToCart(e.currentTarget.dataset.id)));
        }
        function createProductCard(p) {
            return `<div class="product-card">
                        <div class="product-image"><img src="https://via.placeholder.com/300x200?text=${p.name.replace(/\s+/g, '+')}" alt="${p.name}"></div>
                        <div class="product-info">
                            <p class="product-category">${p.category}</p>
                            <h3 class="product-title">${p.name}</h3>
                            <p class="product-description">${p.description || ''}</p>
                            <div class="product-footer">
                                <span class="product-price">$${p.price.toFixed(2)}</span>
                                <button class="add-to-cart" data-id="${p.id}"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>`;
        }

        // --- ORDER VIEWS ---
        function listenForWaiterOrders() {
            const query = db.collection("orders").where(currentUserRole === 'waiter' ? 'waiterId' : 'userId', "==", currentUser.uid).orderBy("date", "desc");
            realtimeOrdersListener = query.onSnapshot(snapshot => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFilteredOrders(waiterOrdersContainer, waiterFilter);
            }, console.error);
        }
        function listenForKitchenOrders() {
            const query = db.collection("orders").orderBy("date", "asc");
            realtimeOrdersListener = query.onSnapshot(snapshot => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFilteredOrders(kitchenOrdersContainer, chefFilter);
            }, console.error);
        }
        function listenForCashierOrders() {
            const query = db.collection("orders").orderBy("date", "desc");
            realtimeOrdersListener = query.onSnapshot(snapshot => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFilteredOrders(cashierOrdersContainer, cashierFilter);
            }, console.error);
        }

        function renderFilteredOrders(container, filter) {
            if (!container) return;
            const statusMap = { active: ['pending', 'preparing', 'ready'], history: ['paid', 'cancelled'] };
            const targetStatuses = statusMap[filter] || [filter];
            const filtered = allOrders.filter(order => targetStatuses.includes(order.status));
            
            container.innerHTML = filtered.length === 0 ? '<p class="empty-list-message">No hay pedidos.</p>' : filtered.map(createOrderCard).join('');
            setupCardActions(container);
        }
        function createOrderCard(order) {
            let actions = '';
            if (currentUserRole.includes('chef')) {
                if (order.status === 'pending') actions = `<button class="btn-primary" data-action="prepare" data-id="${order.id}">Preparar</button>`;
                if (order.status === 'preparing') actions = `<button class="btn-primary" style="background-color: var(--success);" data-action="ready" data-id="${order.id}">Listo</button>`;
            } else if (currentUserRole === 'cashier' && order.status === 'ready') {
                actions = `<button class="btn-primary" data-action="pay" data-id="${order.id}">Marcar Pagado</button>`;
            }
            return `<div class="order-card status-${order.status}">
                        <div class="order-header">
                            <div><h4>Pedido #${order.id.slice(-6)}</h4><span>${order.table ? `Mesa ${order.table}` : (order.userName || 'Cliente')}</span></div>
                            <span class="item-status status-${order.status}">${getStatusText(order.status)}</span>
                        </div>
                        <div class="order-items">${(order.items || []).map(it => `<div class="order-item"><span>${it.quantity}x</span> <span>${it.name}</span></div>`).join('')}</div>
                        ${actions ? `<div class="order-actions">${actions}</div>` : ''}
                    </div>`;
        }
        function setupCardActions(container) {
            if (!container) return;
            container.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                const { action, id } = target.dataset;
                if(action === 'prepare') updateOrderStatus(id, 'preparing');
                if(action === 'ready') updateOrderStatus(id, 'ready');
                if(action === 'pay') updateOrderStatus(id, 'paid');
            });
        }
        function updateOrderStatus(orderId, status) {
            db.collection("orders").doc(orderId).update({ status }).then(() => showNotification("Estado actualizado")).catch(err => showNotification('Error al actualizar', 'error'));
        }

        // --- CART LOGIC ---
        function getActiveCart() {
            if (currentUserRole === 'waiter') {
                if (!currentTable) { showNotification('Seleccione una mesa', 'error'); return null; }
                if (!cartByTable[currentTable]) cartByTable[currentTable] = [];
                return cartByTable[currentTable];
            }
            return cart;
        }
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const activeCart = getActiveCart();
            if (!product || !activeCart) return;
            const item = activeCart.find(i => i.id === productId);
            if (item) item.quantity++;
            else activeCart.push({ ...product, quantity: 1 });
            showNotification(`${product.name} añadido`);
            updateCartCount();
        }
        function updateCartCount() {
            const activeCart = getActiveCart();
            const count = activeCart ? activeCart.reduce((sum, item) => sum + item.quantity, 0) : 0;
            document.querySelectorAll('.cart-count').forEach(el => el.textContent = count);
        }
        function openCartModal() {
            renderCart();
            cartModal.classList.add('visible');
            const isWaiter = currentUserRole === 'waiter';
            checkoutBtn.style.display = isWaiter ? 'none' : 'block';
            processOrderBtn.style.display = isWaiter ? 'block' : 'none';
        }
        function closeCartModal() {
            cartModal.classList.remove('visible');
        }
        function renderCart() {
            const container = document.getElementById('cartItemsContainer');
            const activeCart = getActiveCart();
            if (!container || !activeCart) return;

            if (!activeCart || activeCart.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--gray-text);">Tu carrito está vacío.</p>';
                return;
            }
            container.innerHTML = activeCart.map(item => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding: 0.5rem 0;">
                    <div><p style="font-weight:600;">${item.name}</p><p style="font-size:0.875rem; color:var(--gray-text);">$${item.price.toFixed(2)}</p></div><div>${item.quantity}</div>
                </div>`).join('');
        }
        async function processWaiterOrder() {
            const activeCart = getActiveCart();
            if (!activeCart || activeCart.length === 0 || !currentTable) return showNotification('Seleccione mesa y añada productos.', 'error');
            const order = {
                date: new Date().toISOString(), waiterId: currentUser.uid,
                userName: `Mesa ${currentTable}`, items: activeCart,
                total: activeCart.reduce((s, i) => s + (i.price * i.quantity), 0),
                status: 'pending', table: currentTable
            };
            try {
                await db.collection("orders").add(order);
                showNotification(`Pedido para Mesa ${currentTable} enviado.`);
                cartByTable[currentTable] = [];
                document.querySelector('.table-card.active')?.classList.remove('active');
                currentTable = null;
                updateCartCount();
                closeCartModal();
            } catch (error) { showNotification('Error al guardar el pedido', 'error'); }
        }
        async function checkout() {
            if (cart.length === 0) return showNotification('El carrito está vacío', 'error');
            const order = {
                date: new Date().toISOString(), userId: currentUser.uid,
                userName: currentUser.displayName, items: cart,
                total: cart.reduce((s, i) => s + (i.price * i.quantity), 0),
                status: 'pending',
            };
            try {
                await db.collection("orders").add(order);
                showNotification(`Pedido enviado con éxito.`);
                cart = [];
                updateCartCount();
                closeCartModal();
            } catch (error) { showNotification('Error al guardar el pedido', 'error'); }
        }

        // --- WAITER LOGIC ---
        function listenForTableLocks() {
            const tableContainer = document.getElementById('tableSelection');
            if(!tableContainer) return;
            tableContainer.innerHTML = '<h2 class="section-title">Seleccione una Mesa</h2><div class="tables-grid">' + 
            [...Array(10)].map((_, i) => `<div class="table-card" data-table="${i+1}"><i class="fas fa-utensils"></i><span>Mesa ${i+1}</span></div>`).join('') + '</div>';

            tableContainer.addEventListener('click', e => {
                const card = e.target.closest('.table-card');
                if (!card || card.classList.contains('locked')) return;
                tableContainer.querySelector('.active')?.classList.remove('active');
                card.classList.add('active');
                currentTable = card.dataset.table;
                const menuTitle = document.getElementById('waiterMenuTitle');
                menuTitle.textContent = `Menú para la Mesa ${currentTable}`;
                menuTitle.style.display = 'block';
            });

            db.collection("orders").where("status", "in", ["pending", "preparing", "ready"]).onSnapshot(snapshot => {
                const lockedTables = new Set(snapshot.docs.map(doc => doc.data().table));
                tableContainer.querySelectorAll('.table-card').forEach(card => card.classList.toggle('locked', lockedTables.has(card.dataset.table)));
            });
        }
        function renderWaiterProducts() {
            const container = document.getElementById('waiterProductsContainer');
            if (!container) return;
            container.innerHTML = products.map(createProductCard).join('');
            container.querySelectorAll('.add-to-cart').forEach(b => b.addEventListener('click', e => addToCart(e.currentTarget.dataset.id)));
        }

        // --- PROFILE ---
        function renderProfile() {
            const container = document.getElementById('profileContainer');
            if (!container || !currentUser) return;
            const creationDate = currentUser.metadata.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleDateString() : 'N/A';
            container.innerHTML = `
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">${(currentUser.displayName || 'C').charAt(0)}</div>
                        <h3>${currentUser.displayName || 'Cliente'}</h3>
                        <p>${currentUser.email}</p>
                    </div>
                    <div class="profile-details">
                        <div class="detail-item"><span>Miembro desde</span> <span>${creationDate}</span></div>
                        <div class="detail-item"><span>Pedidos totales</span> <span id="profileOrderCount">0</span></div>
                    </div>
                </div>`;
            db.collection('orders').where('userId', '==', currentUser.uid).get().then(s => {
                const countEl = document.getElementById('profileOrderCount');
                if(countEl) countEl.textContent = s.size;
            });
        }
        
        // --- UTILS & HELPERS ---
        function getStatusText(status) {
            const texts = { pending: 'Entrante', preparing: 'En preparación', ready: 'Listo', paid: 'Pagado', cancelled: 'Cancelado' };
            return texts[status] || status;
        }
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--primary)';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }
        function openSidebarFunc() { sidebar.classList.add('open'); overlay.classList.add('active'); }
        function closeSidebarFunc() { sidebar.classList.remove('open'); overlay.classList.remove('active'); }
        
        // --- EVENT LISTENERS (Setup once) ---
        function setupFilterControls() {
            const configs = [
                { id: 'waiterFilterControls', container: waiterOrdersContainer, filterVar: 'waiterFilter', buttons: [{t:'Activos', s:'active'}, {t:'Historial', s:'history'}] },
                { id: 'chefFilterControls', container: kitchenOrdersContainer, filterVar: 'chefFilter', buttons: [{t:'Entrantes', s:'pending'}, {t:'En Preparación', s:'preparing'}, {t:'Listos', s:'ready'}] },
                { id: 'cashierFilterControls', container: cashierOrdersContainer, filterVar: 'cashierFilter', buttons: [{t:'Listos para Pagar', s:'ready'}, {t:'Pagados', s:'paid'}] },
            ];
            configs.forEach(config => {
                const controls = document.getElementById(config.id);
                if (!controls) return;
                controls.innerHTML = config.buttons.map(b => `<button class="filter-btn ${window[config.filterVar] === b.s ? 'active' : ''}" data-status="${b.s}">${b.t}</button>`).join('');
                controls.addEventListener('click', e => {
                    const target = e.target.closest('.filter-btn');
                    if (!target) return;
                    window[config.filterVar] = target.dataset.status;
                    controls.querySelector('.active')?.classList.remove('active');
                    target.classList.add('active');
                    renderFilteredOrders(config.container, window[config.filterVar]);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Auth listeners
            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = authEmail.value, password = authPassword.value;
                authSubmitBtn.disabled = true;
                authSubmitBtn.textContent = 'Procesando...';
                if (authMode === 'login') auth.signInWithEmailAndPassword(email, password).catch(handleAuthError);
                else if (authMode === 'register') {
                    if (password !== authConfirmPassword.value) { handleAuthError({ message: "Las contraseñas no coinciden." }); return; }
                    auth.createUserWithEmailAndPassword(email, password).catch(handleAuthError);
                } else if (authMode === 'forgot') {
                    auth.sendPasswordResetEmail(email).then(() => { showNotification("Correo de recuperación enviado."); setAuthMode('login'); }).catch(handleAuthError);
                }
            });
            function handleAuthError(error) {
                showNotification(`Error: ${error.message}`, 'error');
                setAuthMode(authMode);
                authSubmitBtn.disabled = false;
            }
            signUpLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('register'); });
            forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('forgot'); });
            loginLink.addEventListener('click', (e) => { e.preventDefault(); setAuthMode('login'); });
            googleLoginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(handleAuthError));
            appleLoginBtn.addEventListener('click', () => auth.signInWithPopup(new firebase.auth.OAuthProvider('apple.com')).catch(handleAuthError));

            // General listeners
            desktopCartBtn.addEventListener('click', openCartModal);
            cartModal.querySelector('.close-modal')?.addEventListener('click', closeCartModal);
            logoutBtn.addEventListener('click', () => auth.signOut());
            checkoutBtn.addEventListener('click', checkout);
            processOrderBtn.addEventListener('click', processWaiterOrder);
            menuToggle.addEventListener('click', openSidebarFunc);
            closeSidebar.addEventListener('click', closeSidebarFunc);
            overlay.addEventListener('click', closeSidebarFunc);
        });
    </script>
</body>
</html>